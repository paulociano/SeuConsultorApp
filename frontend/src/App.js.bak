import React, { useState, useMemo, useEffect, createContext, useContext } from 'react';
import { PieChart, Pie, Cell, ResponsiveContainer, Legend, Tooltip, AreaChart, Area, XAxis, YAxis, CartesianGrid } from 'recharts';
import logo from './assets/logo.svg';
import { ThemeContext } from './ThemeContext';
import { 
    Home, UserPlus, LogIn, PiggyBank, BarChart2, Shield, ShoppingCart, 
    Briefcase, TrendingUp, Menu, X, PlusCircle, ChevronDown, ChevronRight, 
    Trash2, Edit, DollarSign, HeartHandshake, Users, CircleDollarSign, 
    Stethoscope, Car, Target, Landmark, Coins, CarFront, Building2, 
    Gift, Package, Utensils, Film, Eye, EyeOff 
} from 'lucide-react';
// ... outras importações ...
import { Sun, Moon } from 'lucide-react'; // Importe os ícones Sun e Moon
import { v4 as uuidv4 } from 'uuid';

// --- DADOS MOCK (Substituir por chamadas de API no futuro) ---
const initialOrcamentoData = [
    { id: 'renda', nome: 'Renda', tipo: 'receita', icon: DollarSign, subItens: [ { id: 1, nome: 'Salário', atual: 7000, sugerido: 7000 } ] },
    { id: 'essencial', nome: 'Fixo Essencial', tipo: 'despesa', icon: Home, subItens: [ { id: 2, nome: 'Aluguel', atual: 1500, sugerido: 1500 }, { id: 3, nome: 'Energia', atual: 250, sugerido: 220 } ] },
    { id: 'variavel', nome: 'Variável', tipo: 'despesa', icon: ShoppingCart, subItens: [ { id: 4, nome: 'Supermercado', atual: 800, sugerido: 750 }, { id: 5, nome: 'Lazer', atual: 400, sugerido: 500 } ] },
    { id: 'investimento', nome: 'Investimento', tipo: 'despesa', icon: Briefcase, subItens: [ { id: 6, nome: 'Ações', atual: 500, sugerido: 700 } ] },
    { id: 'protecao', nome: 'Proteção', tipo: 'despesa', icon: Shield, subItens: [ { id: 7, nome: 'Seguro de Vida', atual: 100, sugerido: 100 } ] },
];

const mockInvestimentos = [
    { id: 'inv1', nome: 'Tesouro Selic', valor: 5000 },
    { id: 'inv2', nome: 'CDB 100% CDI', valor: 10000 },
    { id: 'inv3', nome: 'Fundo DI', valor: 7500 },
    { id: 'inv4', nome: 'Poupança', valor: 2000 },
];

const initialPatrimonioData = {
    investimentos: [{ id: 1, nome: 'Ações Nacionais', valor: 50000 }],
    automoveis: [{ id: 2, nome: 'Carro Principal', valor: 90000 }],
    imoveis: [{ id: 3, nome: 'Apartamento', valor: 450000 }],
    contaBancaria: [{ id: 4, nome: 'Conta Corrente', valor: 12000 }],
    beneficios: [],
    outros: [],
    dividas: [{ id: 5, nome: 'Financiamento Veículo', valor: 35000 }],
};

const PIE_COLORS = ['#00d971', '#a39ee8', '#FFBB28', '#FF8042', '#AF19FF'];


// --- FUNÇÕES UTILITÁRIAS ---
const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);

// --- COMPONENTES DE TELA ---

const TelaLogin = ({ setCurrentPage, setIsAuthenticated }) => {
  const handleLogin = (e) => { e.preventDefault(); setIsAuthenticated(true); setCurrentPage('orcamento'); };
  return (
    <div className="flex items-center justify-center min-h-screen bg-[#201b5d]">
      <div className="w-full max-w-md p-8 space-y-8 bg-[#2a246f] rounded-xl shadow-lg">
        <div className="text-center"><h1 className="text-3xl font-bold text-white">Bem-vindo!</h1><p className="mt-2 text-slate-800 dark:text-white text-sm">Faça login para controlar suas finanças</p></div>
        <form className="space-y-6" onSubmit={handleLogin}>
          <div><label className="block text-sm font-medium text-slate-800 dark:text-white">Email</label><input type="email" required className="w-full px-3 py-2 mt-1 text-white bg-[#201b5d] border border-[#3e388b] rounded-md focus:outline-none focus:ring-2 focus:ring-[#00d971]" placeholder="seu@email.com" /></div>
          <div><label className="block text-sm font-medium text-slate-800 dark:text-white">Senha</label><input type="password" required className="w-full px-3 py-2 mt-1 text-white bg-[#201b5d] border border-[#3e388b] rounded-md focus:outline-none focus:ring-2 focus:ring-[#00d971]" placeholder="********" /></div>
          <button type="submit" className="w-full py-2 font-semibold text-white bg-[#00d971] rounded-md hover:brightness-90 transition duration-300 flex items-center justify-center gap-2 text-base"><LogIn size={18} /> Entrar</button>
        </form>
        <p className="text-xs text-center text-slate-800 dark:text-white">Não tem uma conta?{' '}<button onClick={() => setCurrentPage('cadastro')} className="font-medium text-[#00d971] hover:underline">Cadastre-se</button></p>
      </div>
    </div>
  );
};

const TelaCadastro = ({ setCurrentPage }) => {
    const handleCadastro = (e) => { e.preventDefault(); alert("Cadastro realizado com sucesso! Por favor, faça o login."); setCurrentPage('login'); };
  return (
    <div className="flex items-center justify-center min-h-screen bg-[#201b5d]">
      <div className="w-full max-w-md p-8 space-y-8 bg-[#2a246f] rounded-xl shadow-lg">
        <div className="text-center"><h1 className="text-3xl font-bold text-white">Crie sua Conta</h1><p className="mt-2 text-slate-800 dark:text-white text-sm">Comece sua jornada para a saúde financeira</p></div>
        <form className="space-y-6" onSubmit={handleCadastro}>
          <div><label className="block text-sm font-medium text-slate-800 dark:text-white">Nome</label><input type="text" required className="w-full px-3 py-2 mt-1 text-white bg-[#201b5d] border border-[#3e388b] rounded-md focus:outline-none focus:ring-2 focus:ring-[#00d971]" placeholder="Seu Nome Completo" /></div>
          <div><label className="block text-sm font-medium text-slate-800 dark:text-white">Email</label><input type="email" required className="w-full px-3 py-2 mt-1 text-white bg-[#201b5d] border border-[#3e388b] rounded-md focus:outline-none focus:ring-2 focus:ring-[#00d971]" placeholder="seu@email.com" /></div>
          <div><label className="block text-sm font-medium text-slate-800 dark:text-white">Senha</label><input type="password" required className="w-full px-3 py-2 mt-1 text-white bg-[#201b5d] border border-[#3e388b] rounded-md focus:outline-none focus:ring-2 focus:ring-[#00d971]" placeholder="Crie uma senha forte" /></div>
          <button type="submit" className="w-full py-2 font-semibold text-black bg-[#00d971] rounded-md hover:brightness-90 transition duration-300 flex items-center justify-center gap-2 text-base"><UserPlus size={18} /> Cadastrar</button>
        </form>
        <p className="text-xs text-center text-slate-800 dark:text-white">Já tem uma conta?{' '}<button onClick={() => setCurrentPage('login')} className="font-medium text-[#00d971] hover:underline">Faça login</button></p>
      </div>
    </div>
  );
};

const Card = ({ children, className = '' }) => (
    <div className={`bg-white dark:bg-[#201b5d] p-4 rounded-xl shadow-lg border border-slate-200 dark:border-transparent ${className}`}>
        {children}
    </div>
);

// --- TELA DE ORÇAMENTO ---
const ModalItemOrcamento = ({ isOpen, onClose, onSave, context }) => {
    const [nome, setNome] = useState('');
    const [valor, setValor] = useState('');
    const isEditing = context.mode === 'edit';
    useEffect(() => {
        if (isEditing && context.item) { setNome(context.item.nome); setValor(context.item.atual.toString()); }
        else { setNome(''); setValor(''); }
    }, [context, isEditing, isOpen]);
    if (!isOpen) return null;
    const handleSubmit = (e) => {
        e.preventDefault();
        onSave({ nome, valor: parseFloat(valor), id: isEditing ? context.item.id : null });
        onClose();
    };
    return (
        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
            <div className="bg-[#2a246f] rounded-lg p-8 w-full max-w-md">
                <h2 className="text-xl font-bold text-white mb-4">{isEditing ? 'Editar Item' : `Adicionar em ${context.category.nome}`}</h2>
                <form onSubmit={handleSubmit}>
                    <div className="mb-4"><label className="block text-slate-800 dark:text-white text-sm font-bold mb-2">Nome</label><input value={nome} onChange={(e) => setNome(e.target.value)} type="text" required className="w-full px-3 py-2 mt-1 text-white bg-[#201b5d] border border-[#3e388b] rounded-md focus:outline-none focus:ring-2 focus:ring-[#00d971]" /></div>
                    <div className="mb-6"><label className="block text-slate-800 dark:text-white text-sm font-bold mb-2">Valor (R$)</label><input value={valor} onChange={(e) => setValor(e.target.value)} type="number" step="0.01" required className="w-full px-3 py-2 mt-1 text-white bg-[#201b5d] border border-[#3e388b] rounded-md focus:outline-none focus:ring-2 focus:ring-[#00d971]" /></div>
                    <div className="flex items-center justify-end gap-4"><button type="button" onClick={onClose} className="text-slate-800 dark:text-white hover:text-white transition">Cancelar</button><button type="submit" className="bg-[#00d971] hover:brightness-90 text-[#201b5d] font-bold py-2 px-4 rounded">Salvar</button></div>
                </form>
            </div>
        </div>
    );
};

const CustomPieLegend = ({ payload, chartData }) => {
    return (
        <div className="mt-4 text-xs">
            <div className="flex items-center justify-between font-bold mb-2 px-1">
                <span className="text-slate-800 dark:text-white">Categoria</span>
                <div className="flex gap-4">
                    <span className="text-slate-800 dark:text-white w-12 text-center">Atual</span>
                    <span className="text-slate-800 dark:text-white w-12 text-center">Sugerido</span>
                </div>
            </div>
            <ul className="flex flex-col gap-1">
                {payload.map((entry) => {
                    const itemData = chartData.find(d => d.name === entry.value);
                    if (!itemData) return null;
                    return (
                        <li key={`item-${entry.value}`} className="flex items-center justify-between p-1 rounded-md hover:bg-white/5">
                            <div className="flex items-center gap-2">
                                <div className="w-2 h-2 rounded-full" style={{ backgroundColor: entry.color }} />
                                <span className="text-slate-800 dark:text-white">{entry.value}</span>
                            </div>
                            <div className="flex gap-4">
                                <span className="font-semibold text-slate-800 dark:text-white w-12 text-center">{itemData.percAtual}%</span>
                                <span className="font-semibold text-[#a39ee8] w-12 text-center">{itemData.percSugerido}%</span>
                            </div>
                        </li>
                    );
                })}
            </ul>
        </div>
    );
};

const TelaOrcamento = ({ categorias, setCategorias, orcamentoCalculos, pieChartData }) => {
    const [expandedCategories, setExpandedCategories] = useState({});
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [modalContext, setModalContext] = useState({ mode: 'add', category: null, item: null });
    const [editingSugeridoId, setEditingSugeridoId] = useState(null);
    const [sugeridoInputValue, setSugeridoInputValue] = useState("");

    const toggleCategory = (categoryId) => setExpandedCategories(prev => ({ ...prev, [categoryId]: !prev[categoryId] }));
    const handleOpenModal = (mode, category, item = null) => { setModalContext({ mode, category, item }); setIsModalOpen(true); };
    const handleSaveItem = ({ nome, valor, id }) => {
        const categoryId = modalContext.category.id;
        setCategorias(prev => prev.map(cat => {
            if (cat.id === categoryId) {
                const subItens = id ? cat.subItens.map(item => item.id === id ? { ...item, nome, atual: valor } : item) : [...cat.subItens, { id: Date.now(), nome, atual: valor, sugerido: valor }];
                return { ...cat, subItens };
            }
            return cat;
        }));
    };
    const handleDeleteItem = (categoryId, itemId) => {
        setCategorias(prev => prev.map(cat => {
            if (cat.id === categoryId) return { ...cat, subItens: cat.subItens.filter(item => item.id !== itemId) };
            return cat;
        }));
    };
    const handleEditSugeridoClick = (item) => {
        setEditingSugeridoId(item.id);
        setSugeridoInputValue(item.sugerido.toString());
    };
    const handleSugeridoSave = (categoryId, itemId) => {
        const newValue = parseFloat(sugeridoInputValue);
        if (!isNaN(newValue)) {
            setCategorias(prev => prev.map(cat => {
                if (cat.id === categoryId) {
                    return { ...cat, subItens: cat.subItens.map(item => item.id === itemId ? { ...item, sugerido: newValue } : item) };
                }
                return cat;
            }));
        }
        setEditingSugeridoId(null);
    };
    const handleSugeridoInputKeyDown = (e, categoryId, itemId) => {
        if (e.key === 'Enter') handleSugeridoSave(categoryId, itemId);
        if (e.key === 'Escape') setEditingSugeridoId(null);
    };

    return (
        <div className="grid grid-cols-1 lg:grid-cols-5 gap-6">
            <div className="lg:col-span-3">
                <Card className="mb-4">
                    <div className="grid grid-cols-3 gap-4 text-center text-sm">
                        <div></div><div className="font-bold text-slate-800 dark:text-white">Atual</div><div className="font-bold text-slate-800 dark:text-white">Sugerido</div>
                    </div>
                    <div className="grid grid-cols-3 gap-4 text-center mt-2 border-t border-[#3e388b] pt-3">
                        <div className="text-left font-semibold text-white text-sm">Saldo esperado</div>
                        <div className="font-semibold text-base text-[#00d971]">{formatCurrency(orcamentoCalculos.atual.receitas - orcamentoCalculos.atual.despesas)}</div>
                        <div className="font-semibold text-base text-[#a39ee8]">{formatCurrency(orcamentoCalculos.sugerido.receitas - orcamentoCalculos.sugerido.despesas)}</div>
                    </div>
                </Card>
                <Card>
                    <div className="space-y-1">
                        <div className="grid grid-cols-3 items-center gap-4 p-2 text-sm"><span className="font-semibold text-slate-800 dark:text-white"></span><span className="font-semibold text-slate-800 dark:text-white text-right">Atual</span><span className="font-semibold text-slate-800 dark:text-white text-right">Sugerido</span></div>
                        {categorias.map(cat => {
                            const Icon = cat.icon;
                            const isExpanded = !!expandedCategories[cat.id];
                            const totalAtual = cat.subItens.reduce((acc, item) => acc + item.atual, 0);
                            const percAtual = orcamentoCalculos.atual.despesas > 0 ? (totalAtual / orcamentoCalculos.atual.despesas) * 100 : 0;
                            const corTexto = cat.tipo === 'receita' ? 'text-[#00d971]' : 'text-red-400';
                            return (
                                <div key={cat.id} className="border-t border-[#3e388b]">
                                    <div className="grid grid-cols-3 items-center gap-4 p-2 hover:bg-[#3e388b]/30 rounded-lg cursor-pointer text-sm" onClick={() => toggleCategory(cat.id)}>
                                        <div className="flex items-center gap-2"><button className="text-slate-800 dark:text-white hover:text-white">{isExpanded ? <ChevronDown size={16} /> : <ChevronRight size={16} />}</button><Icon size={18} className="text-slate-800 dark:text-white" /><span className="font-bold text-white">{cat.nome}</span></div>
                                        <div className={`text-right font-semibold ${corTexto}`}>{cat.tipo === 'despesa' && <span className="text-xs text-slate-800 dark:text-white mr-2">({percAtual.toFixed(1)}%)</span>}{formatCurrency(totalAtual)}</div>
                                        <div className="text-right font-semibold text-[#a39ee8]">{formatCurrency(cat.subItens.reduce((acc, item) => acc + item.sugerido, 0))}</div>
                                    </div>
                                    {isExpanded && (<div className="pl-10 pr-4 pb-2 space-y-2 text-xs">
                                        {cat.subItens.map(item => (<div key={item.id} className="grid grid-cols-3 items-center gap-4">
                                            <span className="text-slate-800 dark:text-white col-span-1">{item.nome}</span>
                                            <div className="flex justify-end items-center gap-2"><span className="text-slate-800 dark:text-white text-right">{formatCurrency(item.atual)}</span><button onClick={(e) => {e.stopPropagation(); handleOpenModal('edit', cat, item)}} className="text-slate-800 dark:text-white hover:text-[#00d971]"><Edit size={12}/></button><button onClick={(e) => {e.stopPropagation(); handleDeleteItem(cat.id, item.id)}} className="text-slate-800 dark:text-white hover:text-red-400"><Trash2 size={12}/></button></div>
                                            <div className="text-right flex justify-end items-center gap-2">
                                                {editingSugeridoId === item.id ? (
                                                    <input type="number" value={sugeridoInputValue} onChange={(e) => setSugeridoInputValue(e.target.value)} onBlur={() => handleSugeridoSave(cat.id, item.id)} onKeyDown={(e) => handleSugeridoInputKeyDown(e, cat.id, item.id)} className="w-20 bg-[#201b5d] text-slate-800 dark:text-white text-right rounded-md px-1 py-0.5 border border-[#00d971] focus:outline-none focus:ring-1 focus:ring-[#00d971]" autoFocus onClick={(e) => e.stopPropagation()} />
                                                ) : (
                                                    <>
                                                        <span className="text-[#a39ee8]">{formatCurrency(item.sugerido)}</span>
                                                        <button onClick={(e) => {e.stopPropagation(); handleEditSugeridoClick(item)}} className="text-slate-800 dark:text-white hover:text-[#00d971]"><Edit size={12} /></button>
                                                    </>
                                                )}
                                            </div>
                                        </div>))}
                                        <div className="pt-2"><button onClick={(e) => {e.stopPropagation(); handleOpenModal('add', cat)}} className="flex items-center gap-2 text-xs text-[#00d971] hover:brightness-90 font-semibold"><PlusCircle size={14} />Adicionar</button></div>
                                    </div>)}
                                </div>
                            );
                        })}
                    </div>
                </Card>
            </div>
            <div className="lg:col-span-2">
                <Card>
                    <h2 className="text-lg font-bold text-white mb-4 text-center">Divisão de Gastos</h2>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <h3 className="text-center font-semibold text-slate-800 dark:text-white mb-2 text-sm">Atual</h3>
                            <ResponsiveContainer width="100%" height={150}>
                                <PieChart>
                                    <Tooltip formatter={(value) => formatCurrency(value)} />
                                    <Pie data={pieChartData} dataKey="valueAtual" nameKey="name" cx="50%" cy="50%" outerRadius={60} label>
                                        {pieChartData.map((entry, index) => (<Cell key={`cell-${index}`} fill={PIE_COLORS[index % PIE_COLORS.length]} />))}
                                    </Pie>
                                </PieChart>
                            </ResponsiveContainer>
                        </div>
                        <div>
                            <h3 className="text-center font-semibold text-[#a39ee8] mb-2 text-sm">Sugerido</h3>
                            <ResponsiveContainer width="100%" height={150}>
                                <PieChart>
                                    <Tooltip formatter={(value) => formatCurrency(value)} />
                                    <Pie data={pieChartData} dataKey="valueSugerido" nameKey="name" cx="50%" cy="50%" outerRadius={60} label>
                                        {pieChartData.map((entry, index) => (<Cell key={`cell-${index}`} fill={PIE_COLORS[index % PIE_COLORS.length]} />))}
                                    </Pie>
                                </PieChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                    <CustomPieLegend payload={pieChartData.map((d, i) => ({ value: d.name, color: PIE_COLORS[i % PIE_COLORS.length] }))} chartData={pieChartData} />
                </Card>
            </div>
            <ModalItemOrcamento isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleSaveItem} context={modalContext} />
        </div>
    );
};

// --- TELA DE PROTEÇÃO ---
const TelaProtecao = ({ rendaMensal, custoDeVidaMensal, patrimonioTotal }) => {
    const [rentabilidadeAnual, setRentabilidadeAnual] = useState(10);
    const [protecoesTemporarias, setProtecoesTemporarias] = useState([]);
    const [editingItemId, setEditingItemId] = useState(null);
    const [editingItemData, setEditingItemData] = useState({ cobertura: '', observacoes: '' });
    const [tipoProtecaoPermanente, setTipoProtecaoPermanente] = useState('renda');
    const [percentualInventario, setPercentualInventario] = useState(15);
    const [possuiHolding, setPossuiHolding] = useState(false);
    const [despesasFuturas, setDespesasFuturas] = useState([]);
    const [editingFuturaId, setEditingFuturaId] = useState(null);
    const [editingFuturaData, setEditingFuturaData] = useState({ nome: '', anoInicio: '', valorMensal: '', prazoMeses: '' });
    const [doencasGravesTempo, setDoencasGravesTempo] = useState(12);
    const [doencasGravesBase, setDoencasGravesBase] = useState('renda');
    const [protecaoPatrimonial, setProtecaoPatrimonial] = useState([]);
    const [editingPatrimonialId, setEditingPatrimonialId] = useState(null);
    const [editingPatrimonialData, setEditingPatrimonialData] = useState({ nome: '', dataVencimento: '', empresa: '', valor: '' });

    const { capitalRenda, capitalCustoVida } = useMemo(() => {
        const taxaIR = 15; // Alíquota de IR fixa em 15%
        if (rentabilidadeAnual <= 0) return { capitalRenda: 0, capitalCustoVida: 0 };

        const rendimentoBrutoDecimal = rentabilidadeAnual / 100;
        const taxaIrDecimal = taxaIR / 100;
        const rendimentoLiquidoDecimal = rendimentoBrutoDecimal * (1 - taxaIrDecimal);

        if (rendimentoLiquidoDecimal <= 0) return { capitalRenda: 0, capitalCustoVida: 0 };

        const capitalRenda = (rendaMensal * 12) / rendimentoLiquidoDecimal;
        const capitalCustoVida = (custoDeVidaMensal * 12) / rendimentoLiquidoDecimal;

        return { capitalRenda, capitalCustoVida };
    }, [rendaMensal, custoDeVidaMensal, rentabilidadeAnual]);

    const protecaoPermanenteSelecionada = useMemo(() => {
        return tipoProtecaoPermanente === 'renda'
            ? { id: 'auto-renda', nome: 'Proteção da Renda', cobertura: capitalRenda, observacoes: 'Cálculo automático' }
            : { id: 'auto-cv', nome: 'Proteção do Custo de Vida', cobertura: capitalCustoVida, observacoes: 'Cálculo automático' };
    }, [tipoProtecaoPermanente, capitalRenda, capitalCustoVida]);

    const totalCoberturaInvalidez = useMemo(() => {
        const totalTemporaria = protecoesTemporarias.reduce((acc, item) => acc + item.cobertura, 0);
        return protecaoPermanenteSelecionada.cobertura + totalTemporaria;
    }, [protecaoPermanenteSelecionada, protecoesTemporarias]);

    const custoInventario = useMemo(() => {
        return patrimonioTotal * (percentualInventario / 100);
    }, [patrimonioTotal, percentualInventario]);

    const totalCoberturaMorte = useMemo(() => {
        const totalDespesasFuturas = despesasFuturas.reduce((acc, item) => acc + (item.valorMensal * item.prazoMeses), 0);
        return custoInventario + totalDespesasFuturas;
    }, [custoInventario, despesasFuturas]);

    const coberturaDoencasGraves = useMemo(() => {
        const base = doencasGravesBase === 'renda' ? rendaMensal : custoDeVidaMensal;
        return base * doencasGravesTempo;
    }, [doencasGravesBase, doencasGravesTempo, rendaMensal, custoDeVidaMensal]);

    useEffect(() => {
        if (possuiHolding) {
            setPercentualInventario(4);
        }
    }, [possuiHolding]);

    const handlePercentualInventarioChange = (e) => {
        let value = parseFloat(e.target.value);
        if (isNaN(value)) value = 0;
        if (value < 4) value = 4;
        if (value > 20) value = 20;
        setPercentualInventario(value);
    };

    const handleAddProtecaoTemporaria = (tipo) => {
        const newProtecao = {
            id: uuidv4();
            nome: `Proteção Temporária (${tipo === 'renda' ? 'Renda' : 'Custo de Vida'})`,
            cobertura: tipo === 'renda' ? rendaMensal : custoDeVidaMensal,
            observacoes: 'Contratado'
        };
        setProtecoesTemporarias(prev => [...prev, newProtecao]);
    };

    const handleDeleteProtecao = (id) => {
        setProtecoesTemporarias(prev => prev.filter(p => p.id !== id));
    };

    const handleStartEdit = (item) => {
        setEditingItemId(item.id);
        setEditingItemData({ cobertura: item.cobertura, observacoes: item.observacoes });
    };

    const handleCancelEdit = () => {
        setEditingItemId(null);
    };

    const handleSaveEdit = (id) => {
        setProtecoesTemporarias(prev => prev.map(p =>
            p.id === id ? { ...p, cobertura: parseFloat(editingItemData.cobertura) || 0, observacoes: editingItemData.observacoes } : p
        ));
        setEditingItemId(null);
    };

    const handleAddDespesaFutura = () => {
        const newDespesa = {
            id: Date.now(),
            nome: 'Nova Despesa',
            anoInicio: new Date().getFullYear(),
            valorMensal: 1000,
            prazoMeses: 12
        };
        setDespesasFuturas(prev => [...prev, newDespesa]);
    };

    const handleDeleteDespesaFutura = (id) => {
        setDespesasFuturas(prev => prev.filter(d => d.id !== id));
    };

    const handleStartEditFutura = (item) => {
        setEditingFuturaId(item.id);
        setEditingFuturaData({ ...item });
    };

    const handleCancelEditFutura = () => {
        setEditingFuturaId(null);
    };

    const handleSaveEditFutura = (id) => {
        setDespesasFuturas(prev => prev.map(d =>
            d.id === id ? { ...d, ...editingFuturaData, valorMensal: parseFloat(editingFuturaData.valorMensal) || 0, prazoMeses: parseInt(editingFuturaData.prazoMeses) || 0, anoInicio: parseInt(editingFuturaData.anoInicio) || 0 } : d
        ));
        setEditingFuturaId(null);
    };

    const handleAddPatrimonial = () => {
        const newItem = {
            id: Date.now(),
            nome: 'Seguro Auto',
            dataVencimento: new Date().toISOString().split('T')[0],
            empresa: 'Empresa Exemplo',
            valor: 50000
        };
        setProtecaoPatrimonial(prev => [...prev, newItem]);
    };

    const handleDeletePatrimonial = (id) => {
        setProtecaoPatrimonial(prev => prev.filter(p => p.id !== id));
    };

    const handleStartEditPatrimonial = (item) => {
        setEditingPatrimonialId(item.id);
        setEditingPatrimonialData({ ...item });
    };

    const handleCancelEditPatrimonial = () => {
        setEditingPatrimonialId(null);
    };

    const handleSaveEditPatrimonial = (id) => {
        setProtecaoPatrimonial(prev => prev.map(p =>
            p.id === id ? { ...p, ...editingPatrimonialData, valor: parseFloat(editingPatrimonialData.valor) || 0 } : p
        ));
        setEditingPatrimonialId(null);
    };

    return (
        <div className="max-w-6xl mx-auto">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                <Card>
                    <p className="text-sm text-slate-800 dark:text-white">Cobertura Invalidez</p>
                    <p className="text-2xl font-bold text-[#00d971]">{formatCurrency(totalCoberturaInvalidez)}</p>
                </Card>
                <Card>
                    <p className="text-sm text-slate-800 dark:text-white">Cobertura Morte</p>
                    <p className="text-2xl font-bold text-[#00d971]">{formatCurrency(totalCoberturaMorte)}</p>
                </Card>
                <Card>
                    <p className="text-sm text-slate-800 dark:text-white">Doenças Graves</p>
                    <p className="text-2xl font-bold text-[#00d971]">{formatCurrency(coberturaDoencasGraves)}</p>
                </Card>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Coluna Esquerda */}
                <div className="space-y-6">
                    <Card>
                        <div className="flex items-center gap-3 mb-4">
                            <Users className="text-[#00d971]" size={24} />
                            <h2 className="text-lg font-bold text-white">Planejamento Sucessório</h2>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 text-sm items-end">
                             <div className="md:col-span-1">
                                <label className="block font-medium text-slate-800 dark:text-white">Patrimônio Total:</label>
                                <input type="number" value={patrimonioTotal} readOnly className="mt-1 w-full bg-[#201b5d] text-slate-800 dark:text-white rounded-md px-2 py-1 border border-[#3e388b] focus:outline-none focus:ring-1 focus:ring-[#00d971] opacity-70" />
                            </div>
                            <div className="flex items-end gap-4 md:col-span-2">
                                <div>
                                    <label className="block font-medium text-slate-800 dark:text-white">Inventário (%):</label>
                                    <input type="number" value={percentualInventario} onChange={handlePercentualInventarioChange} disabled={possuiHolding} min="4" max="20" className="mt-1 w-full bg-[#201b5d] text-white rounded-md px-2 py-1 border border-[#3e388b] focus:outline-none focus:ring-1 focus:ring-[#00d971] disabled:opacity-50" />
                                </div>
                                <label className="flex items-center gap-2 cursor-pointer pb-1">
                                    <input type="checkbox" checked={possuiHolding} onChange={e => setPossuiHolding(e.target.checked)} className="form-checkbox h-4 w-4 text-[#00d971] bg-gray-700 border-gray-600 rounded focus:ring-[#00d971]" />
                                    <span className="text-slate-800 dark:text-white">Holding</span>
                                </label>
                            </div>
                        </div>
                        <div className="space-y-4 text-sm mt-6">
                             <div>
                                <div className="flex justify-between items-center bg-[#201b5d]/50 p-2 rounded-t-lg">
                                    <h3 className="font-bold text-white">Despesas Futuras</h3>
                                    <button onClick={handleAddDespesaFutura} className="text-xs flex items-center gap-1 text-[#00d971] hover:brightness-90"><PlusCircle size={14} /> Adicionar</button>
                                </div>
                                <div className="space-y-1 bg-[#201b5d]/20 p-2 rounded-b-lg">
                                    {despesasFuturas.length > 0 && (
                                        <div className="grid grid-cols-12 gap-2 items-center px-2 pb-2 border-b border-[#3e388b] font-bold text-slate-800 dark:text-white">
                                            <p className="col-span-3">Descrição</p>
                                            <p className="col-span-2">Início</p>
                                            <p className="col-span-2">Valor/Mês</p>
                                            <p className="col-span-2">Prazo</p>
                                            <p className="col-span-1">Total</p>
                                            <p className="col-span-2"></p>
                                        </div>
                                    )}
                                    {despesasFuturas.length > 0 ? despesasFuturas.map(item => (
                                        <div key={item.id} className="grid grid-cols-12 gap-2 items-center p-2 hover:bg-[#3e388b]/30 rounded">
                                            {editingFuturaId === item.id ? (
                                                <>
                                                    <input type="text" value={editingFuturaData.nome} onChange={e => setEditingFuturaData({...editingFuturaData, nome: e.target.value})} className="col-span-3 bg-[#201b5d] text-slate-800 dark:text-white rounded-md px-1 py-0.5 border border-[#00d971]"/>
                                                    <input type="number" value={editingFuturaData.anoInicio} onChange={e => setEditingFuturaData({...editingFuturaData, anoInicio: e.target.value})} className="col-span-2 bg-[#201b5d] text-slate-800 dark:text-white rounded-md px-1 py-0.5 border border-[#00d971]"/>
                                                    <input type="number" value={editingFuturaData.valorMensal} onChange={e => setEditingFuturaData({...editingFuturaData, valorMensal: e.target.value})} className="col-span-2 bg-[#201b5d] text-slate-800 dark:text-white rounded-md px-1 py-0.5 border border-[#00d971]"/>
                                                    <input type="number" value={editingFuturaData.prazoMeses} onChange={e => setEditingFuturaData({...editingFuturaData, prazoMeses: e.target.value})} className="col-span-2 bg-[#201b5d] text-slate-800 dark:text-white rounded-md px-1 py-0.5 border border-[#00d971]"/>
                                                    <div className="col-span-3 flex justify-end items-center gap-3">
                                                        <button onClick={() => handleSaveEditFutura(item.id)} className="text-slate-800 dark:text-white hover:text-[#00d971]">Salvar</button>
                                                        <button onClick={handleCancelEditFutura} className="text-slate-800 dark:text-white hover:text-red-400">X</button>
                                                    </div>
                                                </>
                                            ) : (
                                                <>
                                                    <p className="col-span-3 text-slate-800 dark:text-white">{item.nome}</p>
                                                    <p className="col-span-2 text-slate-800 dark:text-white">{item.anoInicio}</p>
                                                    <p className="col-span-2 text-slate-800 dark:text-white">{formatCurrency(item.valorMensal)}</p>
                                                    <p className="col-span-2 text-slate-800 dark:text-white">{item.prazoMeses} meses</p>
                                                    <p className="col-span-1 font-semibold text-white">{formatCurrency(item.valorMensal * item.prazoMeses)}</p>
                                                    <div className="col-span-2 flex justify-end items-center gap-3">
                                                        <button onClick={() => handleStartEditFutura(item)} className="text-slate-800 dark:text-white hover:text-[#00d971]"><Edit size={16} /></button>
                                                        <button onClick={() => handleDeleteDespesaFutura(item.id)} className="text-slate-800 dark:text-white hover:text-red-400"><Trash2 size={16} /></button>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    )) : <p className="text-center text-slate-800 dark:text-white p-2 text-xs">Nenhuma despesa futura adicionada.</p>}
                                </div>
                            </div>
                             <div className="flex justify-between items-center p-3 border-t border-[#3e388b] mt-4">
                                <h3 className="text-base font-bold text-white">Total Cobertura de Morte:</h3>
                                <p className="text-base font-bold text-[#00d971]">{formatCurrency(totalCoberturaMorte)}</p>
                            </div>
                        </div>
                    </Card>
                    <Card>
                        <div className="flex items-center gap-3 mb-4">
                            <Stethoscope className="text-[#00d971]" size={24} />
                            <h2 className="text-lg font-bold text-white">Cobertura de Doenças Graves</h2>
                        </div>
                         <div className="space-y-2 text-sm">
                            <div className="flex items-center gap-6 mb-2">
                                <p className="font-medium text-slate-800 dark:text-white">Tempo de cobertura:</p>
                                {[12, 18, 24].map(tempo => (
                                    <label key={tempo} className="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" name="doencas-tempo" value={tempo} checked={doencasGravesTempo === tempo} onChange={() => setDoencasGravesTempo(tempo)} className="form-radio h-4 w-4 text-[#00d971] bg-gray-700 border-gray-600 focus:ring-[#00d971]" />
                                        <span className="text-slate-800 dark:text-white">{tempo} meses</span>
                                    </label>
                                ))}
                            </div>
                             <div className="flex items-center gap-6 mb-4">
                                <p className="font-medium text-slate-800 dark:text-white">Base de cálculo:</p>
                                <label className="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="doencas-base" value="renda" checked={doencasGravesBase === 'renda'} onChange={() => setDoencasGravesBase('renda')} className="form-radio h-4 w-4 text-[#00d971] bg-gray-700 border-gray-600 focus:ring-[#00d971]" />
                                    <span className="text-slate-800 dark:text-white">Renda</span>
                                </label>
                                 <label className="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="doencas-base" value="custo" checked={doencasGravesBase === 'custo'} onChange={() => setDoencasGravesBase('custo')} className="form-radio h-4 w-4 text-[#00d971] bg-gray-700 border-gray-600 focus:ring-[#00d971]" />
                                    <span className="text-slate-800 dark:text-white">Custo de Vida</span>
                                </label>
                            </div>
                             <div className="bg-[#201b5d]/50 p-3 rounded-lg flex justify-between items-center">
                                <p className="text-base font-semibold text-white">Cobertura Necessária:</p>
                                <p className="text-lg font-bold text-[#00d971]">{formatCurrency(coberturaDoencasGraves)}</p>
                            </div>
                        </div>
                    </Card>
                </div>

                {/* Coluna Direita */}
                <div className="space-y-6">
                    <Card>
                        <div className="flex items-center gap-3 mb-4">
                            <HeartHandshake className="text-[#00d971]" size={24} />
                            <h2 className="text-lg font-bold text-white">Cobertura Invalidez</h2>
                        </div>
                        <div className="space-y-4 text-sm">
                            <div>
                                <div className="flex justify-between items-center bg-[#201b5d]/50 p-2 rounded-t-lg">
                                    <h3 className="font-bold text-white">Invalidez Permanente</h3>
                                </div>
                                <div className="space-y-1 bg-[#201b5d]/20 p-3 rounded-b-lg">
                                    <div className="flex items-center gap-6 mb-2">
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="protecao-permanente" value="renda" checked={tipoProtecaoPermanente === 'renda'} onChange={() => setTipoProtecaoPermanente('renda')} className="form-radio h-4 w-4 text-[#00d971] bg-gray-700 border-gray-600 focus:ring-[#00d971]" />
                                            <span className="text-slate-800 dark:text-white">Proteção da Renda</span>
                                        </label>
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="protecao-permanente" value="custo" checked={tipoProtecaoPermanente === 'custo'} onChange={() => setTipoProtecaoPermanente('custo')} className="form-radio h-4 w-4 text-[#00d971] bg-gray-700 border-gray-600 focus:ring-[#00d971]" />
                                            <span className="text-slate-800 dark:text-white">Custo de Vida</span>
                                        </label>
                                    </div>
                                    <div className="grid grid-cols-12 gap-2 items-center p-2 rounded">
                                        <p className="col-span-4 text-slate-800 dark:text-white">{protecaoPermanenteSelecionada.nome}</p>
                                        <p className="col-span-4 font-semibold text-slate-800 dark:text-white">{formatCurrency(protecaoPermanenteSelecionada.cobertura)}</p>
                                        <p className="col-span-4 text-slate-800 dark:text-white italic">{protecaoPermanenteSelecionada.observacoes}</p>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div className="flex justify-between items-center bg-[#201b5d]/50 p-2 rounded-t-lg">
                                    <h3 className="font-bold text-white">Invalidez Temporária</h3>
                                    <div className="flex gap-4">
                                        <button onClick={() => handleAddProtecaoTemporaria('renda')} className="text-xs flex items-center gap-1 text-[#00d971] hover:brightness-90"><PlusCircle size={14} /> Renda</button>
                                        <button onClick={() => handleAddProtecaoTemporaria('custo')} className="text-xs flex items-center gap-1 text-[#00d971] hover:brightness-90"><PlusCircle size={14} /> Custo de Vida</button>
                                    </div>
                                </div>
                                <div className="space-y-1 bg-[#201b5d]/20 p-2 rounded-b-lg">
                                    {protecoesTemporarias.length > 0 ? protecoesTemporarias.map(item => (
                                        <div key={item.id} className="grid grid-cols-12 gap-2 items-center p-2 hover:bg-[#3e388b]/30 rounded">
                                            {editingItemId === item.id ? (
                                                <>
                                                    <p className="col-span-4 text-slate-800 dark:text-white text-xs">{item.nome}</p>
                                                    <input type="number" value={editingItemData.cobertura} onChange={e => setEditingItemData({...editingItemData, cobertura: e.target.value})} className="col-span-3 bg-[#201b5d] text-slate-800 dark:text-white rounded-md px-1 py-0.5 border border-[#00d971]"/>
                                                    <input type="text" value={editingItemData.observacoes} onChange={e => setEditingItemData({...editingItemData, observacoes: e.target.value})} className="col-span-3 bg-[#201b5d] text-slate-800 dark:text-white rounded-md px-1 py-0.5 border border-[#00d971]"/>
                                                    <div className="col-span-2 flex justify-end items-center gap-3">
                                                        <button onClick={() => handleSaveEdit(item.id)} className="text-slate-800 dark:text-white hover:text-[#00d971]">Salvar</button>
                                                        <button onClick={handleCancelEdit} className="text-slate-800 dark:text-white hover:text-red-400">X</button>
                                                    </div>
                                                </>
                                            ) : (
                                                <>
                                                    <p className="col-span-4 text-slate-800 dark:text-white">{item.nome}</p>
                                                    <p className="col-span-3 font-semibold text-white">{formatCurrency(item.cobertura)}</p>
                                                    <p className="col-span-3 text-slate-800 dark:text-white italic">{item.observacoes}</p>
                                                    <div className="col-span-2 flex justify-end items-center gap-3">
                                                        <button onClick={() => handleStartEdit(item)} className="text-slate-800 dark:text-white hover:text-[#00d971]"><Edit size={16} /></button>
                                                        <button onClick={() => handleDeleteProtecao(item.id)} className="text-slate-800 dark:text-white hover:text-red-400"><Trash2 size={16} /></button>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    )) : <p className="text-center text-slate-800 dark:text-white p-2 text-xs">Nenhuma proteção adicionada.</p>}
                                </div>
                            </div>
                        </div>
                    </Card>
                    <Card>
                         <div className="flex justify-between items-center bg-[#201b5d]/50 p-2 rounded-t-lg mb-2">
                            <h3 className="font-bold text-white flex items-center gap-2"><Car size={18}/> Proteção Patrimonial</h3>
                            <button onClick={handleAddPatrimonial} className="text-xs flex items-center gap-1 text-[#00d971] hover:brightness-90"><PlusCircle size={14} /> Adicionar Seguro</button>
                        </div>
                         <div className="space-y-1 bg-[#201b5d]/20 p-2 rounded-b-lg text-sm">
                            {protecaoPatrimonial.length > 0 && (
                                <div className="grid grid-cols-12 gap-2 items-center px-2 pb-2 border-b border-[#3e388b] font-bold text-slate-800 dark:text-white">
                                    <p className="col-span-3">Nome</p>
                                    <p className="col-span-3">Empresa</p>
                                    <p className="col-span-2">Vencimento</p>
                                    <p className="col-span-2">Valor</p>
                                    <p className="col-span-2"></p>
                                </div>
                            )}
                            {protecaoPatrimonial.length > 0 ? protecaoPatrimonial.map(item => (
                                <div key={item.id} className="grid grid-cols-12 gap-2 items-center p-2 hover:bg-[#3e388b]/30 rounded">
                                    {editingPatrimonialId === item.id ? (
                                        <>
                                            <input type="text" value={editingPatrimonialData.nome} onChange={e => setEditingPatrimonialData({...editingPatrimonialData, nome: e.target.value})} className="col-span-3 bg-[#201b5d] text-slate-800 dark:text-white rounded-md px-1 py-0.5 border border-[#00d971]"/>
                                            <input type="text" value={editingPatrimonialData.empresa} onChange={e => setEditingPatrimonialData({...editingPatrimonialData, empresa: e.target.value})} className="col-span-3 bg-[#201b5d] text-slate-800 dark:text-white rounded-md px-1 py-0.5 border border-[#00d971]"/>
                                            <input type="date" value={editingPatrimonialData.dataVencimento} onChange={e => setEditingPatrimonialData({...editingPatrimonialData, dataVencimento: e.target.value})} className="col-span-2 bg-[#201b5d] text-slate-800 dark:text-white rounded-md px-1 py-0.5 border border-[#00d971]"/>
                                            <input type="number" value={editingPatrimonialData.valor} onChange={e => setEditingPatrimonialData({...editingPatrimonialData, valor: e.target.value})} className="col-span-2 bg-[#201b5d] text-slate-800 dark:text-white rounded-md px-1 py-0.5 border border-[#00d971]"/>
                                            <div className="col-span-2 flex justify-end items-center gap-3">
                                                <button onClick={() => handleSaveEditPatrimonial(item.id)} className="text-slate-800 dark:text-white hover:text-[#00d971]">Salvar</button>
                                                <button onClick={handleCancelEditPatrimonial} className="text-slate-800 dark:text-white hover:text-red-400">X</button>
                                            </div>
                                        </>
                                    ) : (
                                        <>
                                            <p className="col-span-3 text-slate-800 dark:text-white">{item.nome}</p>
                                            <p className="col-span-3 text-slate-800 dark:text-white">{item.empresa}</p>
                                            <p className="col-span-2 text-slate-800 dark:text-white">{item.dataVencimento}</p>
                                            <p className="col-span-2 font-semibold text-white">{formatCurrency(item.valor)}</p>
                                            <div className="col-span-2 flex justify-end items-center gap-3">
                                                <button onClick={() => handleStartEditPatrimonial(item)} className="text-slate-800 dark:text-white hover:text-[#00d971]"><Edit size={16} /></button>
                                                <button onClick={() => handleDeletePatrimonial(item.id)} className="text-slate-800 dark:text-white hover:text-red-400"><Trash2 size={16} /></button>
                                            </div>
                                        </>
                                    )}
                                </div>
                            )) : <p className="text-center text-slate-800 dark:text-white p-2 text-xs">Nenhum seguro patrimonial adicionado.</p>}
                        </div>
                    </Card>
                </div>
            </div>
        </div>
    );
};

// --- TELA DE RESERVA DE EMERGÊNCIA ---
const TelaReservaEmergencia = ({ orcamentoCalculos }) => {
    const [cenario, setCenario] = useState('cenario1');
    const [mesesReservaIdeal, setMesesReservaIdeal] = useState(6);
    const [investimentosSelecionados, setInvestimentosSelecionados] = useState({});

    const baseCalculo = useMemo(() => {
        const { fixos, variaveis, investimentos, renda } = orcamentoCalculos.categorias;
        switch (cenario) {
            case 'cenario1': return fixos + (variaveis * 0.7);
            case 'cenario2': return fixos + variaveis;
            case 'cenario3': return fixos + variaveis + investimentos;
            case 'cenario4': return renda;
            default: return 0;
        }
    }, [cenario, orcamentoCalculos]);

    const reservaMinima = baseCalculo * 3;
    const reservaIdeal = baseCalculo * mesesReservaIdeal;

    const handleSelectInvestimento = (invId) => {
        setInvestimentosSelecionados(prev => ({...prev, [invId]: !prev[invId]}));
    };

    const totalAcumulado = useMemo(() => {
        return mockInvestimentos.reduce((acc, inv) => {
            if(investimentosSelecionados[inv.id]) {
                return acc + inv.valor;
            }
            return acc;
        }, 0);
    }, [investimentosSelecionados]);

    const progresso = reservaIdeal > 0 ? (totalAcumulado / reservaIdeal) * 100 : 0;

    return (
        <div className="max-w-4xl mx-auto">
            <Card className="mb-4">
                <div className="flex items-center gap-3 mb-4">
                    <Target className="text-[#00d971]" size={24} />
                    <h2 className="text-lg font-bold text-white">Cálculo da Reserva</h2>
                </div>
                <div className="mb-4">
                    <label className="block text-sm font-medium text-slate-800 dark:text-white mb-2">Selecione o cenário para o cálculo base:</label>
                    <select value={cenario} onChange={(e) => setCenario(e.target.value)} className="w-full bg-[#201b5d] text-white rounded-md px-2 py-2 border border-[#3e388b] focus:outline-none focus:ring-1 focus:ring-[#00d971]">
                        <option value="cenario1">Fixos + 70% dos Variáveis</option>
                        <option value="cenario2">Fixos + Variáveis</option>
                        <option value="cenario3">Fixos + Variáveis + Investimentos</option>
                        <option value="cenario4">Renda</option>
                    </select>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-center">
                    <div className="bg-[#201b5d]/50 p-3 rounded-lg">
                        <p className="text-sm text-slate-800 dark:text-white">Reserva Mínima (3 meses)</p>
                        <p className="text-xl font-bold text-white mt-1">{formatCurrency(reservaMinima)}</p>
                    </div>
                    <div className="bg-[#201b5d]/50 p-3 rounded-lg">
                        <div className="flex justify-center items-center gap-2">
                             <p className="text-sm text-slate-800 dark:text-white">Reserva Ideal</p>
                             <select value={mesesReservaIdeal} onChange={e => setMesesReservaIdeal(parseInt(e.target.value))} className="bg-transparent text-white border-none focus:ring-0 p-0 text-sm">
                                {[...Array(22).keys()].map(i => <option key={i+3} value={i+3}>{i+3} meses</option>)}
                             </select>
                        </div>
                        <p className="text-2xl font-bold text-[#00d971] mt-1">{formatCurrency(reservaIdeal)}</p>
                    </div>
                </div>
            </Card>
            <Card>
                 <h2 className="text-lg font-bold text-white mb-4">Composição da Reserva</h2>
                 <p className="text-sm text-slate-800 dark:text-white mb-2">Selecione os investimentos que compõem sua reserva de emergência:</p>
                 <div className="space-y-2 text-sm">
                    {mockInvestimentos.map(inv => (
                        <label key={inv.id} className="flex items-center justify-between p-2 bg-[#201b5d]/50 rounded-lg cursor-pointer">
                            <div className="flex items-center gap-3">
                                <input type="checkbox" checked={!!investimentosSelecionados[inv.id]} onChange={() => handleSelectInvestimento(inv.id)} className="form-checkbox h-4 w-4 text-[#00d971] bg-gray-700 border-gray-600 rounded focus:ring-[#00d971]" />
                                <span className="text-white">{inv.nome}</span>
                            </div>
                            <span className="font-semibold text-slate-800 dark:text-white">{formatCurrency(inv.valor)}</span>
                        </label>
                    ))}
                 </div>
                 <div className="mt-6">
                    <div className="flex justify-between items-center mb-1">
                        <p className="text-sm text-white">Progresso da Reserva Ideal</p>
                        <p className="text-sm font-bold text-[#00d971]">{formatCurrency(totalAcumulado)} / {formatCurrency(reservaIdeal)}</p>
                    </div>
                    <div className="w-full bg-[#201b5d] rounded-full h-4">
                        <div className="bg-[#00d971] h-4 rounded-full text-xs text-black flex items-center justify-center font-bold" style={{ width: `${Math.min(progresso, 100)}%` }}>
                           {progresso.toFixed(1)}%
                        </div>
                    </div>
                 </div>
            </Card>
        </div>
    );
};

// --- TELA DE APOSENTADORIA ---
const TelaAposentadoria = () => {
    const [idadeAtual, setIdadeAtual] = useState(30);
    const [idadeAposentadoria, setIdadeAposentadoria] = useState(65);
    const [patrimonioInicial, setPatrimonioInicial] = useState(50000);
    const [rendaDesejada, setRendaDesejada] = useState(5000);
    const [rentabilidadeAnual, setRentabilidadeAnual] = useState(8);
    const [tipoPrevidencia, setTipoPrevidencia] = useState('VGBL');
    const [aportes, setAportes] = useState([{ id: 1, ano: 1, valor: 1000 }]);
    const [aporteRestante, setAporteRestante] = useState(0);

    const { projectionData, capitalNecessario, valorAcumulado } = useMemo(() => {
        const taxaMensal = Math.pow(1 + rentabilidadeAnual / 100, 1 / 12) - 1;
        const anosContribuicao = Math.max(0, idadeAposentadoria - idadeAtual);

        let acumulado = patrimonioInicial;
        const data = [{ idade: idadeAtual, valor: acumulado }];

        // Fase de Acumulação
        for (let i = 0; i < anosContribuicao; i++) {
            const anoAtualContribuicao = i + 1;
            const aporteEspecifico = aportes.find(a => a.ano === anoAtualContribuicao);
            const aporteDoAno = (aporteEspecifico ? aporteEspecifico.valor : aporteRestante) * 12;

            acumulado = (acumulado + aporteDoAno) * (1 + (taxaMensal * 12));
            data.push({ idade: idadeAtual + i + 1, valor: Math.max(0, acumulado) });
        }
        const valorFinalAcumulado = acumulado;

        // Cálculo do Capital Necessário para a renda desejada
        const taxaIR = 0.10; // Alíquota fixa de 10% para regime regressivo de longo prazo
        let capitalNecessarioCalc = 0;
        if(rentabilidadeAnual > 0) {
            const rendimentoLiquidoAnual = (rentabilidadeAnual / 100) * (1 - taxaIR);
            if (rendimentoLiquidoAnual > 0) {
                 capitalNecessarioCalc = (rendaDesejada * 12) / rendimentoLiquidoAnual;
            }
        }

        // Fase de Retirada (sem rendimento para simplificar a projeção de consumo)
        let idadeRetirada = idadeAposentadoria;
        let saldoRetirada = valorFinalAcumulado;
        if(saldoRetirada > 0) {
            while(saldoRetirada > 0 && idadeRetirada < 100) {
                idadeRetirada++;
                saldoRetirada -= (rendaDesejada * 12);
                data.push({ idade: idadeRetirada, valor: Math.max(0, saldoRetirada) });
            }
        }

        // Garante que o gráfico vá até os 100 anos
        const ultimaIdade = data.length > 0 ? data[data.length - 1].idade : idadeAtual;
        if (ultimaIdade < 100) {
            for (let i = ultimaIdade + 1; i <= 100; i++) {
                data.push({ idade: i, valor: 0 });
            }
        }

        return { projectionData: data, capitalNecessario: capitalNecessarioCalc, valorAcumulado: valorFinalAcumulado };
    }, [idadeAtual, idadeAposentadoria, patrimonioInicial, aportes, aporteRestante, rendaDesejada, rentabilidadeAnual, tipoPrevidencia]);

    const handleAporteChange = (id, novoValor) => {
        setAportes(prev => prev.map(a => a.id === id ? {...a, valor: parseFloat(novoValor) || 0} : a));
    };

    const addAporteAno = () => {
        setAportes(prev => {
            const proximoAno = prev.length + 1;
            const anosContribuicao = idadeAposentadoria - idadeAtual;
            if (proximoAno >= anosContribuicao) return prev;
            return [...prev, {id: Date.now(), ano: proximoAno, valor: prev[prev.length - 1]?.valor || 1000}]
        });
    };

    const anosRestantes = (idadeAposentadoria - idadeAtual) - aportes.length;

    return (
        <div className="max-w-6xl mx-auto">
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className='space-y-4'>
                    <Card>
                        <h2 className="text-lg font-bold text-white mb-4">Parâmetros Iniciais</h2>
                        <div className="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <label className="block font-medium text-slate-800 dark:text-white">Idade Atual</label>
                                <input type="number" value={idadeAtual} onChange={e => setIdadeAtual(parseInt(e.target.value) || 0)} className="mt-1 w-full bg-[#201b5d] text-slate-800 dark:text-white rounded-md px-2 py-1 border border-[#3e388b]"/>
                            </div>
                             <div>
                                <label className="block font-medium text-slate-800 dark:text-white">Idade Aposentadoria</label>
                                <input type="number" value={idadeAposentadoria} onChange={e => setIdadeAposentadoria(parseInt(e.target.value) || 0)} className="mt-1 w-full bg-[#201b5d] text-slate-800 dark:text-white rounded-md px-2 py-1 border border-[#3e388b]"/>
                            </div>
                             <div>
                                <label className="block font-medium text-slate-800 dark:text-white">Patrimônio Inicial</label>
                                <input type="number" value={patrimonioInicial} onChange={e => setPatrimonioInicial(parseFloat(e.target.value) || 0)} className="mt-1 w-full bg-[#201b5d] text-slate-800 dark:text-white rounded-md px-2 py-1 border border-[#3e388b]"/>
                            </div>
                            <div>
                                <label className="block font-medium text-slate-800 dark:text-white">Renda Mensal Desejada</label>
                                <input type="number" value={rendaDesejada} onChange={e => setRendaDesejada(parseFloat(e.target.value) || 0)} className="mt-1 w-full bg-[#201b5d] text-slate-800 dark:text-white rounded-md px-2 py-1 border border-[#3e388b]"/>
                            </div>
                             <div>
                                <label className="block font-medium text-slate-800 dark:text-white">Rentabilidade Anual (%)</label>
                                <input type="number" value={rentabilidadeAnual} onChange={e => setRentabilidadeAnual(parseFloat(e.target.value) || 0)} className="mt-1 w-full bg-[#201b5d] text-slate-800 dark:text-white rounded-md px-2 py-1 border border-[#3e388b]"/>
                            </div>
                             <div>
                                <label className="block font-medium text-slate-800 dark:text-white">Tipo de Previdência</label>
                                <select value={tipoPrevidencia} onChange={e => setTipoPrevidencia(e.target.value)} className="mt-1 w-full bg-[#201b5d] text-slate-800 dark:text-white rounded-md px-2 py-1 border border-[#3e388b]">
                                    <option value="VGBL">VGBL</option>
                                    <option value="PGBL">PGBL</option>
                                </select>
                            </div>
                        </div>
                    </Card>
                     <Card>
                        <div className="flex justify-between items-center mb-2">
                             <h2 className="text-lg font-bold text-white">Plano de Aportes</h2>
                             <button onClick={addAporteAno} disabled={anosRestantes <= 0} className="text-xs flex items-center gap-1 text-[#00d971] hover:brightness-90 disabled:opacity-50 disabled:cursor-not-allowed"><PlusCircle size={14} /> Adicionar Ano</button>
                        </div>
                        <div className="space-y-2 max-h-40 overflow-y-auto pr-2">
                        {aportes.map((aporte) => (
                            <div key={aporte.id} className="flex items-center gap-4 text-sm">
                                <label className="text-slate-800 dark:text-white w-16">Ano {aporte.ano}:</label>
                                <input type="number" value={aporte.valor} onChange={e => handleAporteChange(aporte.id, e.target.value)} className="w-full bg-[#201b5d] text-slate-800 dark:text-white rounded-md px-2 py-1 border border-[#3e388b]"/>
                            </div>
                        ))}
                         {anosRestantes > 0 && (
                            <div className="flex items-center gap-4 text-sm pt-2 border-t border-[#3e388b]">
                                <label className="text-slate-800 dark:text-white w-28">Restante ({anosRestantes} anos):</label>
                                <input type="number" value={aporteRestante} onChange={e => setAporteRestante(parseFloat(e.target.value) || 0)} className="w-full bg-[#201b5d] text-slate-800 dark:text-white rounded-md px-2 py-1 border border-[#3e388b]"/>
                            </div>
                         )}
                        </div>
                    </Card>
                </div>
                <Card>
                     <h2 className="text-lg font-bold text-slate-800 dark:text-white mb-4">Projeção</h2>
                     <div className="h-64">
                        <ResponsiveContainer width="100%" height="100%">
                            <AreaChart data={projectionData} margin={{ top: 5, right: 20, left: 20, bottom: 5 }}>
                                <defs>
                                    <linearGradient id="colorValor" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="5%" stopColor="#00d971" stopOpacity={0.8}/>
                                    <stop offset="95%" stopColor="#00d971" stopOpacity={0}/>
                                    </linearGradient>
                                </defs>
                                <CartesianGrid strokeDasharray="3 3" stroke="#3e388b" />
                                <XAxis type="number" dataKey="idade" stroke="#a39ee8" tick={{ fontSize: 12 }} domain={[idadeAtual, 100]} />
                                <YAxis stroke="#a39ee8" tick={{ fontSize: 12 }} tickFormatter={(value) => new Intl.NumberFormat('pt-BR', { notation: 'compact', compactDisplay: 'short' }).format(value)} />
                                <Tooltip
                                    contentStyle={{ backgroundColor: '#2a246f', border: '1px solid #3e388b', borderRadius: '0.5rem' }}
                                    labelStyle={{ color: '#ffffff' }}
                                    formatter={(value) => [formatCurrency(value), 'Patrimônio']}
                                />
                                <Area type="monotone" dataKey="valor" stroke="#00d971" fillOpacity={1} fill="url(#colorValor)" />
                            </AreaChart>
                        </ResponsiveContainer>
                     </div>
                     <div className="grid grid-cols-2 gap-4 mt-4 text-center">
                        <div className="bg-[#201b5d]/50 p-3 rounded-lg">
                            <p className="text-sm text-slate-800 dark:text-white">Capital Necessário</p>
                            <p className="text-xl font-bold text-[#a39ee8] mt-1">{formatCurrency(capitalNecessario)}</p>
                        </div>
                        <div className="bg-[#201b5d]/50 p-3 rounded-lg">
                            <p className="text-sm text-slate-800 dark:text-white">Você terá</p>
                            <p className="text-xl font-bold text-[#00d971] mt-1">{formatCurrency(valorAcumulado)}</p>
                        </div>
                     </div>
                </Card>
            </div>
        </div>
    );
};

// --- TELA DE PATRIMÔNIO ---
const TelaPatrimonio = ({ patrimonioData, setPatrimonioData, patrimonioTotal }) => {
    const patrimonioCategorias = [
        { id: 'investimentos', nome: 'Investimentos', icon: Coins },
        { id: 'automoveis', nome: 'Automóveis', icon: CarFront },
        { id: 'imoveis', nome: 'Imóveis', icon: Building2 },
        { id: 'contaBancaria', nome: 'Conta Bancária', icon: Landmark },
        { id: 'beneficios', nome: 'Benefícios', icon: Gift },
        { id: 'outros', nome: 'Outros', icon: Package },
        { id: 'dividas', nome: 'Dívidas', icon: DollarSign },
    ];

    const [abaAtiva, setAbaAtiva] = useState('investimentos');
    const [editingItemId, setEditingItemId] = useState(null);
    const [editingItemData, setEditingItemData] = useState({ nome: '', valor: '' });

    const handleAddItem = () => {
        const newItem = { id: Date.now(), nome: 'Novo Item', valor: 0 };
        setPatrimonioData(prev => ({
            ...prev,
            [abaAtiva]: [...prev[abaAtiva], newItem]
        }));
    };

    const handleDeleteItem = (id) => {
        setPatrimonioData(prev => ({
            ...prev,
            [abaAtiva]: prev[abaAtiva].filter(item => item.id !== id)
        }));
    };

    const handleStartEdit = (item) => {
        setEditingItemId(item.id);
        setEditingItemData({ nome: item.nome, valor: item.valor });
    };

    const handleCancelEdit = () => {
        setEditingItemId(null);
    };

    const handleSaveEdit = (id) => {
        setPatrimonioData(prev => ({
            ...prev,
            [abaAtiva]: prev[abaAtiva].map(item => 
                item.id === id ? { ...item, ...editingItemData, valor: parseFloat(editingItemData.valor) || 0 } : item
            )
        }));
        setEditingItemId(null);
    };

    return (
        <div className="max-w-4xl mx-auto">
            {/* Card do Título Total - Permanece como está */}
            <Card className="mb-4 text-center">
                <p className="text-sm text-slate-800 dark:text-white">Patrimônio Líquido Total</p>
                <p className="text-3xl font-bold text-[#00d971]">{formatCurrency(patrimonioTotal)}</p>
            </Card>

            {/* ##### ALTERAÇÃO PRINCIPAL: Um novo Card envolve as abas e o conteúdo ##### */}
            <Card>
                {/* 1. Barra de abas agora está DENTRO do card */}
                <div className="flex items-center border-b border-b-[#3e388b] overflow-x-auto">
                    {patrimonioCategorias.map(cat => {
                        const Icon = cat.icon;
                        return (
                            <button 
                                key={cat.id}
                                onClick={() => setAbaAtiva(cat.id)}
                                className={`flex-shrink-0 flex items-center gap-2 px-4 py-2 text-sm font-medium transition-colors duration-200 border-b-2 ${abaAtiva === cat.id ? 'border-[#00d971] text-[#00d971]' : 'border-transparent text-slate-800 dark:text-white hover:text-white'}`}
                            >
                                <Icon size={16} />
                                {cat.nome}
                            </button>
                        );
                    })}
                </div>

                {/* 2. Conteúdo das abas também está DENTRO do mesmo card */}
                <div className="mt-4">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-lg font-bold text-white capitalize">{patrimonioCategorias.find(c => c.id === abaAtiva)?.nome}</h2>
                        <button onClick={handleAddItem} className="text-xs flex items-center gap-1 text-[#00d971] hover:brightness-90"><PlusCircle size={14} /> Adicionar Item</button>
                    </div>
                    <div className="space-y-2 text-sm">
                        {patrimonioData[abaAtiva] && patrimonioData[abaAtiva].length > 0 ? patrimonioData[abaAtiva].map(item => (
                            <div key={item.id} className="grid grid-cols-12 gap-4 items-center p-2 hover:bg-[#2a246f]/50 rounded">
                                {editingItemId === item.id ? (
                                    <>
                                        <input type="text" value={editingItemData.nome} onChange={e => setEditingItemData({...editingItemData, nome: e.target.value})} className="col-span-6 bg-[#2a246f] text-white rounded-md px-2 py-1 border border-[#3e388b]"/>
                                        <input type="number" value={editingItemData.valor} onChange={e => setEditingItemData({...editingItemData, valor: e.target.value})} className="col-span-4 bg-[#2a246f] text-white rounded-md px-2 py-1 border border-[#3e388b]"/>
                                        <div className="col-span-2 flex justify-end items-center gap-3">
                                            <button onClick={() => handleSaveEdit(item.id)} className="text-slate-800 dark:text-white hover:text-[#00d971]">Salvar</button>
                                            <button onClick={handleCancelEdit} className="text-slate-800 dark:text-white hover:text-red-400">X</button>
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <p className="col-span-6 text-slate-800 dark:text-white">{item.nome}</p>
                                        <p className="col-span-4 font-semibold text-white">{formatCurrency(item.valor)}</p>
                                        <div className="col-span-2 flex justify-end items-center gap-3">
                                            <button onClick={() => handleStartEdit(item)} className="text-slate-800 dark:text-white hover:text-[#00d971]"><Edit size={16} /></button>
                                            <button onClick={() => handleDeleteItem(item.id)} className="text-slate-800 dark:text-white hover:text-red-500"><Trash2 size={16} /></button>
                                        </div>
                                    </>
                                )}
                            </div>
                        )) : <p className="text-center text-slate-800 dark:text-white p-4 text-xs">Nenhum item adicionado nesta categoria.</p>}
                    </div>
                </div>
            </Card>
        </div>
    );
};

// 1. COMPONENTE GENÉRICO REUTILIZÁVEL
const TelaAquisicaoGenerica = ({ titulo, descricaoBem, permitirFGTS }) => {
    const initialFormState = {
        descricao: descricaoBem,
        valorTotal: permitirFGTS ? 500000 : 80000,
        valorDisponivel: 10000,
        aporteMensal: permitirFGTS ? 3000 : 1500,
        rentabilidadeMensal: 0.85,
        possuiFGTS: permitirFGTS,
        valorFGTS: permitirFGTS ? 50000 : 0,
        entradaPercentual: 20,
        segurosMensal: permitirFGTS ? 69 : 25,
        tarifasMensal: 25,
        jurosFinanciamento: 9.99,
        prazoFinanciamentoAnos: permitirFGTS ? 30 : 5,
        tabelaAmortizacao: 'SAC',
        reajusteAnualFinanciamento: 3.0,
        prazoConsorcio: permitirFGTS ? 200 : 80,
        taxaAdmTotal: 18.5,
        lancePercentual: 55,
        reajusteAnualConsorcio: 4.5,
    };

    const [novoCaso, setNovoCaso] = useState(initialFormState);
    const [casos, setCasos] = useState([]);
    const [casoSelecionado, setCasoSelecionado] = useState(null);
    const [activeChart, setActiveChart] = useState('acumulo');

    const handleSelectCaso = (caso) => {
        setNovoCaso(caso);
        setCasoSelecionado(caso);
    };
    const handleUpdateCaso = () => {
        if (!casoSelecionado) return;
        const casoAtualizado = { ...novoCaso, id: casoSelecionado.id };
        setCasos(prev => prev.map(c => c.id === casoSelecionado.id ? casoAtualizado : c));
        setCasoSelecionado(casoAtualizado);
        alert("Simulação atualizada com sucesso!");
    };
    const handleDeleteCaso = (idToDelete) => {
        setCasos(prev => prev.filter(c => c.id !== idToDelete));
        if (casoSelecionado?.id === idToDelete) {
            setCasoSelecionado(null);
            setNovoCaso(initialFormState);
        }
    };
    const handleInputChange = (e) => {
        const { name, value, type, checked } = e.target;
        const val = type === 'checkbox' ? checked : (type === 'number' ? parseFloat(value) || 0 : value);
        setNovoCaso(prev => ({ ...prev, [name]: val, ...(name === 'possuiFGTS' && !checked && { valorFGTS: 0 }) }));
    };
    const handleAddCaso = (e) => {
        e.preventDefault();
        if (!novoCaso.descricao || !novoCaso.valorTotal) return;
        const casoAdicionado = { ...novoCaso, id: Date.now() };
        setCasos(prev => [...prev, casoAdicionado]);
        setCasoSelecionado(casoAdicionado);
    };
    
    const calcularPrevisaoComJuros = (valorAlvo, valorDisponivel, aporteMensal, rentabilidade) => {
        if (valorAlvo <= valorDisponivel) return { meses: 0, data: 'Imediata' };
        if (aporteMensal <= 0 && valorDisponivel < valorAlvo) return { meses: Infinity, data: 'N/A' };
        
        const taxaDecimal = rentabilidade / 100;
        let mesesNecessarios = 0;
        let acumulado = valorDisponivel;
        while (acumulado < valorAlvo) {
            acumulado = acumulado * (1 + taxaDecimal) + aporteMensal;
            mesesNecessarios++;
            if (mesesNecessarios > 1200) return { meses: Infinity, data: 'Acima de 100 anos' };
        }
        
        const dataAtual = new Date();
        const dataFutura = new Date(dataAtual.setMonth(dataAtual.getMonth() + mesesNecessarios));
        const nomeMes = dataFutura.toLocaleString('pt-BR', { month: 'long' });
        const ano = dataFutura.getFullYear();
        return { meses: mesesNecessarios, data: `${nomeMes.charAt(0).toUpperCase() + nomeMes.slice(1)}/${ano}` };
    };

    const previsaoEntradaFinanciamento = useMemo(() => {
        if (!casoSelecionado) return { meses: 0, data: 'N/A' };
        const { valorTotal, entradaPercentual, valorDisponivel, aporteMensal, rentabilidadeMensal, possuiFGTS, valorFGTS } = casoSelecionado;
        const valorEntrada = valorTotal * (entradaPercentual / 100);
        const capitalInicialTotal = valorDisponivel + (permitirFGTS && possuiFGTS ? valorFGTS : 0);
        return calcularPrevisaoComJuros(valorEntrada, capitalInicialTotal, aporteMensal, rentabilidadeMensal);
    }, [casoSelecionado, permitirFGTS]);

    const previsaoLanceConsorcio = useMemo(() => {
        if (!casoSelecionado) return { meses: 0, data: 'N/A' };
        const { valorTotal, lancePercentual, taxaAdmTotal, prazoConsorcio, valorDisponivel, aporteMensal, rentabilidadeMensal, possuiFGTS, valorFGTS } = casoSelecionado;
        const valorLance = valorTotal * (lancePercentual / 100);
        const valorTotalConsorcio = valorTotal * (1 + taxaAdmTotal / 100);
        const parcelaConsorcioInicial = prazoConsorcio > 0 ? valorTotalConsorcio / prazoConsorcio : 0;
        const aporteLiquidoParaLance = aporteMensal - parcelaConsorcioInicial;
        const capitalInicialTotal = valorDisponivel + (permitirFGTS && possuiFGTS ? valorFGTS : 0);
        return calcularPrevisaoComJuros(valorLance, capitalInicialTotal, aporteLiquidoParaLance, rentabilidadeMensal);
    }, [casoSelecionado, permitirFGTS]);

    const previsaoAVista = useMemo(() => {
        if (!casoSelecionado) return { meses: 0, data: 'N/A' };
        const { valorTotal, valorDisponivel, aporteMensal, rentabilidadeMensal, possuiFGTS, valorFGTS } = casoSelecionado;
        const capitalInicialTotal = valorDisponivel + (permitirFGTS && possuiFGTS ? valorFGTS : 0);
        return calcularPrevisaoComJuros(valorTotal, capitalInicialTotal, aporteMensal, rentabilidadeMensal);
    }, [casoSelecionado, permitirFGTS]);
    
    const projecaoData = useMemo(() => {
        if (!casoSelecionado) return [];
        const {
            valorTotal, valorDisponivel, aporteMensal, rentabilidadeMensal, possuiFGTS, valorFGTS,
            entradaPercentual, segurosMensal, tarifasMensal, jurosFinanciamento, prazoFinanciamentoAnos, tabelaAmortizacao, reajusteAnualFinanciamento,
            prazoConsorcio, taxaAdmTotal, lancePercentual, reajusteAnualConsorcio
        } = casoSelecionado;
        const taxaJurosMensal = rentabilidadeMensal / 100;
        const maxPrazo = Math.max(prazoFinanciamentoAnos * 12, prazoConsorcio, 360);
        const data = [];
        let capitalLiquidoFin = valorDisponivel; let capitalLiquidoCon = valorDisponivel; let capitalLiquidoAVista = valorDisponivel;
        let saldoDevedorFin = valorTotal - (valorTotal * (entradaPercentual/100)); let saldoDevedorConsorcio = valorTotal * (1 + taxaAdmTotal / 100);
        let parcelaConsorcioAtual = prazoConsorcio > 0 ? saldoDevedorConsorcio / prazoConsorcio : 0; let foiContemplado = false;
        const { meses: mesesParaEntrada } = previsaoEntradaFinanciamento; const { meses: mesesParaLance } = previsaoLanceConsorcio; const { meses: mesesParaAVista } = previsaoAVista;
        for (let i = 1; i <= maxPrazo; i++) {
            let parcelaFin = 0; if (i > mesesParaEntrada && (i - mesesParaEntrada) % 12 === 1 && (i - mesesParaEntrada) > 1) { const reajuste = (1 + reajusteAnualFinanciamento / 100); saldoDevedorFin *= reajuste; }
            if (i >= mesesParaEntrada) { const prazoMesesFin = prazoFinanciamentoAnos * 12; const valorFinanciado = valorTotal - (valorTotal * (entradaPercentual/100)); if (i - mesesParaEntrada < prazoMesesFin && valorFinanciado > 0) { const taxaMensalJuros = jurosFinanciamento / 12 / 100; if (tabelaAmortizacao === 'SAC') { const amortizacao = saldoDevedorFin / (prazoMesesFin - (i - mesesParaEntrada)); parcelaFin = (saldoDevedorFin * taxaMensalJuros) + amortizacao; saldoDevedorFin -= amortizacao; } else { parcelaFin = saldoDevedorFin * (taxaMensalJuros * Math.pow(1 + taxaMensalJuros, prazoMesesFin - (i - mesesParaEntrada))) / (Math.pow(1 + taxaMensalJuros, prazoMesesFin - (i - mesesParaEntrada)) - 1); const jurosDaParcela = saldoDevedorFin * taxaMensalJuros; saldoDevedorFin -= (parcelaFin - jurosDaParcela); } } }
            const desembolsoFin = parcelaFin > 0 ? parcelaFin + segurosMensal + tarifasMensal : 0; const capacidadePoupancaFin = aporteMensal - desembolsoFin;
            let parcelaConsorcioDoMes = 0; if (i <= prazoConsorcio && saldoDevedorConsorcio > 0) { if ((i - 1) > 0 && (i - 1) % 12 === 0) { const reajuste = (1 + reajusteAnualConsorcio / 100); if (foiContemplado) { saldoDevedorConsorcio *= reajuste; const prazoRestante = prazoConsorcio - (i - 1); parcelaConsorcioAtual = prazoRestante > 0 ? saldoDevedorConsorcio / prazoRestante : 0; } else { let valorCartaAtual = (saldoDevedorConsorcio / (1 + taxaAdmTotal/100)) * prazoConsorcio / (prazoConsorcio - (i-1)); valorCartaAtual *= reajuste; saldoDevedorConsorcio = valorCartaAtual * (1 + taxaAdmTotal/100) / prazoConsorcio * (prazoConsorcio-(i-1)); parcelaConsorcioAtual = (valorCartaAtual * (1+taxaAdmTotal/100))/prazoConsorcio; } } const valorLanceSimulado = valorTotal * (lancePercentual / 100); if (i === mesesParaLance && !foiContemplado && valorLanceSimulado > 0) { const lanceEfetivo = Math.min(valorLanceSimulado, saldoDevedorConsorcio); saldoDevedorConsorcio -= lanceEfetivo; foiContemplado = true; const prazoRestante = prazoConsorcio - (i - 1); parcelaConsorcioAtual = prazoRestante > 0 ? saldoDevedorConsorcio / prazoRestante : 0; } saldoDevedorConsorcio -= parcelaConsorcioAtual; parcelaConsorcioDoMes = parcelaConsorcioAtual; }
            const capacidadePoupancaCon = aporteMensal - parcelaConsorcioDoMes; const fgtsDisponivel = permitirFGTS && possuiFGTS ? valorFGTS : 0;
            if (i < mesesParaEntrada) { capitalLiquidoFin = capitalLiquidoFin * (1 + taxaJurosMensal) + aporteMensal; } else { if(i === mesesParaEntrada) { const valorEntrada = valorTotal * (entradaPercentual/100); capitalLiquidoFin -= Math.max(0, valorEntrada - fgtsDisponivel); } capitalLiquidoFin = capitalLiquidoFin * (1 + taxaJurosMensal) + capacidadePoupancaFin; }
            if (i < mesesParaLance) { capitalLiquidoCon = capitalLiquidoCon * (1 + taxaJurosMensal) + capacidadePoupancaCon; } else { if (i === mesesParaLance) { const valorDoLance = valorTotal * (lancePercentual/100); capitalLiquidoCon -= Math.max(0, valorDoLance - fgtsDisponivel); } capitalLiquidoCon = capitalLiquidoCon * (1 + taxaJurosMensal) + capacidadePoupancaCon; }
            if (i < mesesParaAVista) { capitalLiquidoAVista = capitalLiquidoAVista * (1 + taxaJurosMensal) + aporteMensal; } else { if (i === mesesParaAVista) { capitalLiquidoAVista -= Math.max(0, valorTotal - fgtsDisponivel); } capitalLiquidoAVista = capitalLiquidoAVista * (1 + taxaJurosMensal) + aporteMensal; }
            if (i % 12 === 0) { data.push({ ano: i / 12, capacidadePoupancaFin, capacidadePoupancaCon, parcelaFinanciamento: parcelaFin, parcelaConsorcio: parcelaConsorcioDoMes, acumuloFinanciamento: capitalLiquidoFin, acumuloConsorcio: capitalLiquidoCon, acumuloAVista: capitalLiquidoAVista }); }
        }
        return data;
    }, [casoSelecionado, previsaoEntradaFinanciamento, previsaoLanceConsorcio, previsaoAVista, permitirFGTS]);

    return (
        <div className="max-w-6xl mx-auto">
            <h1 className="text-2xl font-bold text-white mb-4">{titulo}</h1>
            <Card className="mb-6">
                <form onSubmit={handleAddCaso}>
                    <h3 className="text-lg font-bold text-white mb-2">Dados Gerais da Simulação</h3>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 text-sm">
                        <div className="md:col-span-2">
                            <label className="block font-medium text-slate-800 dark:text-white">Descrição</label>
                            <input type="text" name="descricao" value={novoCaso.descricao} onChange={handleInputChange} className="mt-1 w-full bg-[#201b5d] text-white rounded-md px-2 py-1 border border-[#3e388b]"/>
                        </div>
                        <div><label className="block font-medium text-slate-800 dark:text-white">Valor do Bem</label><input type="number" name="valorTotal" value={novoCaso.valorTotal} onChange={handleInputChange} className="mt-1 w-full bg-[#201b5d] text-white rounded-md px-2 py-1 border border-[#3e388b]"/></div>
                        <div><label className="block font-medium text-slate-800 dark:text-white">Disponível Hoje</label><input type="number" name="valorDisponivel" value={novoCaso.valorDisponivel} onChange={handleInputChange} className="mt-1 w-full bg-[#201b5d] text-white rounded-md px-2 py-1 border border-[#3e388b]"/></div>
                        <div><label className="block font-medium text-slate-800 dark:text-white">Aporte Mensal</label><input type="number" name="aporteMensal" value={novoCaso.aporteMensal} onChange={handleInputChange} className="mt-1 w-full bg-[#201b5d] text-white rounded-md px-2 py-1 border border-[#3e388b]"/></div>
                        <div><label className="block font-medium text-slate-800 dark:text-white">Rentabilidade Mensal (%)</label><input type="number" name="rentabilidadeMensal" value={novoCaso.rentabilidadeMensal} onChange={handleInputChange} step="0.01" className="mt-1 w-full bg-[#201b5d] text-white rounded-md px-2 py-1 border border-[#3e388b]"/></div>
                        
                        {permitirFGTS && (
                            <div className="md:col-span-2 flex items-end gap-4">
                                <label className="flex items-center gap-2 cursor-pointer pb-1"><input type="checkbox" name="possuiFGTS" checked={novoCaso.possuiFGTS} onChange={handleInputChange} className="form-checkbox h-4 w-4 text-[#00d971] bg-gray-700 border-gray-600 rounded focus:ring-[#00d971]" /><span className="text-slate-800 dark:text-white">Possui FGTS?</span></label>
                                {novoCaso.possuiFGTS && (
                                    <div className="flex-1"><label className="block font-medium text-slate-800 dark:text-white">Valor FGTS</label><input type="number" name="valorFGTS" value={novoCaso.valorFGTS} onChange={handleInputChange} className="mt-1 w-full bg-[#201b5d] text-white rounded-md px-2 py-1 border border-[#3e388b]"/></div>
                                )}
                            </div>
                        )}
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        <div>
                            <h3 className="text-lg font-bold text-white mb-2 border-t border-[#3e388b] pt-4">Parâmetros do Financiamento</h3>
                            <div className="grid grid-cols-2 gap-4 text-sm">
                                <div><label className="block font-medium text-slate-800 dark:text-white">Juros (% a.a.)</label><input type="number" name="jurosFinanciamento" value={novoCaso.jurosFinanciamento} onChange={handleInputChange} className="w-full bg-[#201b5d] text-white rounded-md px-2 py-1 border border-[#3e388b]"/></div>
                                <div><label className="block font-medium text-slate-800 dark:text-white">Prazo (anos)</label><input type="number" name="prazoFinanciamentoAnos" value={novoCaso.prazoFinanciamentoAnos} onChange={handleInputChange} className="w-full bg-[#201b5d] text-white rounded-md px-2 py-1 border border-[#3e388b]"/></div>
                                <div><label className="block font-medium text-slate-800 dark:text-white">Entrada (%)</label><input type="number" name="entradaPercentual" value={novoCaso.entradaPercentual} onChange={handleInputChange} className="w-full bg-[#201b5d] text-white rounded-md px-2 py-1 border border-[#3e388b]"/></div>
                                <div><label className="block font-medium text-slate-800 dark:text-white">Tabela</label><select name="tabelaAmortizacao" value={novoCaso.tabelaAmortizacao} onChange={handleInputChange} className="w-full bg-[#201b5d] text-white rounded-md px-2 py-1 border border-[#3e388b]"><option value="SAC">SAC</option><option value="Price">Price</option></select></div>
                                <div><label className="block font-medium text-slate-800 dark:text-white">Seguros (R$/mês)</label><input type="number" name="segurosMensal" value={novoCaso.segurosMensal} onChange={handleInputChange} className="w-full bg-[#201b5d] text-white rounded-md px-2 py-1 border border-[#3e388b]"/></div>
                                <div><label className="block font-medium text-slate-800 dark:text-white">Tarifas (R$/mês)</label><input type="number" name="tarifasMensal" value={novoCaso.tarifasMensal} onChange={handleInputChange} className="w-full bg-[#201b5d] text-white rounded-md px-2 py-1 border border-[#3e388b]"/></div>
                                <div className="md:col-span-2"><label className="block font-medium text-slate-800 dark:text-white">Reajuste Anual do Saldo Devedor (%)</label><input type="number" name="reajusteAnualFinanciamento" value={novoCaso.reajusteAnualFinanciamento} onChange={handleInputChange} className="w-full bg-[#201b5d] text-white rounded-md px-2 py-1 border border-[#3e388b]"/></div>
                            </div>
                        </div>
                        <div>
                            <h3 className="text-lg font-bold text-white mb-2 border-t border-[#3e388b] pt-4">Parâmetros do Consórcio</h3>
                            <div className="grid grid-cols-2 gap-4 text-sm">
                                <div><label className="block font-medium text-slate-800 dark:text-white">Taxa Adm Total (%)</label><input type="number" name="taxaAdmTotal" value={novoCaso.taxaAdmTotal} onChange={handleInputChange} className="w-full bg-[#201b5d] text-white rounded-md px-2 py-1 border border-[#3e388b]"/></div>
                                <div><label className="block font-medium text-slate-800 dark:text-white">Prazo (meses)</label><input type="number" name="prazoConsorcio" value={novoCaso.prazoConsorcio} onChange={handleInputChange} className="w-full bg-[#201b5d] text-white rounded-md px-2 py-1 border border-[#3e388b]"/></div>
                                <div><label className="block font-medium text-slate-800 dark:text-white">Lance (%)</label><input type="number" name="lancePercentual" value={novoCaso.lancePercentual} onChange={handleInputChange} className="w-full bg-[#201b5d] text-white rounded-md px-2 py-1 border border-[#3e388b]"/></div>
                                <div><label className="block font-medium text-slate-800 dark:text-white">Reajuste Anual (%)</label><input type="number" name="reajusteAnualConsorcio" value={novoCaso.reajusteAnualConsorcio} onChange={handleInputChange} className="w-full bg-[#201b5d] text-white rounded-md px-2 py-1 border border-[#3e388b]"/></div>
                            </div>
                        </div>
                    </div>
                    
                    <div className="mt-6 flex justify-end gap-4">
                        <button type="button" onClick={handleUpdateCaso} disabled={!casoSelecionado} className="bg-blue-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"><Edit size={16}/> Atualizar Simulação</button>
                        <button type="submit" className="bg-[#00d971] text-black font-semibold py-2 px-6 rounded-md hover:brightness-90 flex items-center justify-center gap-2"><PlusCircle size={18}/> Adicionar como Nova</button>
                    </div>
                </form>
            </Card>

            {casos.length > 0 && (
                 <div className="mb-6">
                     <h3 className="text-lg font-bold text-white mb-2">Simulações Salvas</h3>
                     <div className="flex flex-wrap gap-2">
                        {casos.map(c => (
                            <div key={c.id} className="flex items-center rounded-full bg-[#2a246f] hover:bg-[#3e388b] transition-colors has-[:focus]:ring-2 ring-white/50">
                                <button onClick={() => handleSelectCaso(c)} className={`pl-3 pr-2 py-1 text-xs transition-colors ${casoSelecionado?.id === c.id ? 'text-[#00d971] font-bold' : 'text-white'}`}>{c.descricao}</button>
                                <button onClick={(e) => { e.stopPropagation(); handleDeleteCaso(c.id); }} className="pr-2 text-slate-800 dark:text-white hover:text-red-500"><Trash2 size={12} /></button>
                            </div>
                        ))}
                     </div>
                </div>
            )}
            
            {casoSelecionado && (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="space-y-4">
                        <Card><h3 className="font-bold text-base text-white">Financiamento</h3><p className="text-xs text-slate-800 dark:text-white mb-2">{`Juros: ${casoSelecionado.jurosFinanciamento}% a.a, Prazo: ${casoSelecionado.prazoFinanciamentoAnos} anos, Entrada: ${casoSelecionado.entradaPercentual}%`}</p><div className="bg-[#201b5d]/50 p-2 rounded-lg text-xs"><p className="text-slate-800 dark:text-white">Previsão p/ Entrada:</p><p className="font-bold text-lg text-[#00d971]">{previsaoEntradaFinanciamento.data}</p></div></Card>
                        <Card><h3 className="font-bold text-base text-white">Consórcio</h3><p className="text-xs text-slate-800 dark:text-white mb-2">{`Taxa Adm: ${casoSelecionado.taxaAdmTotal}%, Prazo: ${casoSelecionado.prazoConsorcio} meses, Lance: ${casoSelecionado.lancePercentual}%`}</p><div className="bg-[#201b5d]/50 p-2 rounded-lg text-xs"><p className="text-slate-800 dark:text-white">Previsão p/ Lance:</p><p className="font-bold text-lg text-[#00d971]">{previsaoLanceConsorcio.data}</p></div></Card>
                        <Card><h3 className="font-bold text-base text-white">À Vista</h3><p className="text-xs text-slate-800 dark:text-white mb-2">Simulação de acúmulo de capital para compra sem dívida.</p><div className="bg-[#201b5d]/50 p-2 rounded-lg text-xs"><p className="text-slate-800 dark:text-white">Previsão para Acumular Valor Total:</p><p className="font-bold text-lg text-[#00d971]">{previsaoAVista.data}</p></div></Card>
                    </div>
                    <Card>
                        <div className="flex justify-center border-b border-[#3e388b] mb-4">
                            <button onClick={() => setActiveChart('acumulo')} className={`px-4 py-2 text-sm font-medium transition-colors ${activeChart === 'acumulo' ? 'border-b-2 border-[#00d971] text-[#00d971]' : 'text-slate-800 dark:text-white'}`}>Acúmulo de Capital</button>
                            <button onClick={() => setActiveChart('capacidade')} className={`px-4 py-2 text-sm font-medium transition-colors ${activeChart === 'capacidade' ? 'border-b-2 border-[#00d971] text-[#00d971]' : 'text-slate-800 dark:text-white'}`}>Capacidade de Poupar</button>
                            <button onClick={() => setActiveChart('parcela')} className={`px-4 py-2 text-sm font-medium transition-colors ${activeChart === 'parcela' ? 'border-b-2 border-[#00d971] text-[#00d971]' : 'text-slate-800 dark:text-white'}`}>Valor da Parcela</button>
                        </div>
                        <div className="h-96">
                            <ResponsiveContainer width="100%" height="100%"><AreaChart data={projecaoData} margin={{ top: 5, right: 20, left: 20, bottom: 5 }}><CartesianGrid strokeDasharray="3 3" stroke="#3e388b" /><XAxis type="number" domain={[0, 30]} dataKey="ano" stroke="#a39ee8" tick={{ fontSize: 12 }} label={{ value: 'Anos', position: 'insideBottom', offset: -5, fill: '#a39ee8', fontSize: 12 }} /><YAxis stroke="#a39ee8" tick={{ fontSize: 12 }} tickFormatter={(value) => formatCurrency(value)} /><Tooltip contentStyle={{ backgroundColor: '#201b5d', border: '1px solid #3e388b' }} labelFormatter={(label) => `Ano ${label}`} formatter={(value, name) => [formatCurrency(value), name]} /><Legend verticalAlign="top" height={36}/>
                                {activeChart === 'acumulo' && (<><Area type="monotone" dataKey="acumuloAVista" name="Capital (À Vista)" stroke="#ffc658" fill="#ffc658" fillOpacity={0.2} /><Area type="monotone" dataKey="acumuloFinanciamento" name="Capital (Financiamento)" stroke="#00d971" fill="#00d971" fillOpacity={0.2} /><Area type="monotone" dataKey="acumuloConsorcio" name="Capital (Consórcio)" stroke="#c084fc" fill="#c084fc" fillOpacity={0.2} /></>)}
                                {activeChart === 'capacidade' && (<><Area type="monotone" dataKey="capacidadePoupancaFin" name="Poupança Mensal (Financiamento)" stroke="#00d971" fill="#00d971" fillOpacity={0.2} /><Area type="monotone" dataKey="capacidadePoupancaCon" name="Poupança Mensal (Consórcio)" stroke="#c084fc" fill="#c084fc" fillOpacity={0.2} /></>)}
                                {activeChart === 'parcela' && (<><Area type="step" dataKey="parcelaFinanciamento" name="Parcela Financiamento" stroke="#00d971" fill="#00d971" fillOpacity={0.2} /><Area type="step" dataKey="parcelaConsorcio" name="Parcela Consórcio" stroke="#c084fc" fill="#c084fc" fillOpacity={0.2} /></>)}
                            </AreaChart></ResponsiveContainer>
                        </div>
                    </Card>
                </div>
            )}
        </div>
    );
};

// 2. COMPONENTES DE TELA ESPECÍFICOS
const TelaAquisicaoImoveis = () => {
    return (
        <TelaAquisicaoGenerica
            descricaoBem="Apartamento na Praia"
            permitirFGTS={true}
        />
    );
};

const TelaAquisicaoAutomoveis = () => {
    return (
        <TelaAquisicaoGenerica
            descricaoBem="Carro 0km"
            permitirFGTS={false}
        />
    );
};

// Definições de Categorias e Ícones para o Fluxo de Caixa
const CATEGORIAS_FLUXO = {
    alimentacao: { label: 'Alimentação', icon: Landmark, color: '#f97316' },
    transporte: { label: 'Transporte', icon: Car, color: '#3b82f6' },
    moradia: { label: 'Moradia', icon: Home, color: '#ef4444' },
    lazer: { label: 'Lazer', icon: Film, color: '#14b8a6' },
    compras: { label: 'Compras', icon: ShoppingCart, color: '#8b5cf6' },
    saude: { label: 'Saúde', icon: Stethoscope, color: '#ec4899' },
    servicos: { label: 'Serviços e Taxas', icon: Landmark, color: '#6b7280' },
    outros: { label: 'Outros', icon: Package, color: '#facc15' }
};

// Dados de Exemplo - No futuro, isso viria de uma sincronização bancária
const mockTransacoes = [
  { id: 1, date: '2025-07-07', description: 'iFood Pedido #1234', amount: 54.90, type: 'debit', sourceAccount: 'Cartão de Crédito Nubank' },
  { id: 2, date: '2025-07-07', description: 'Uber Viagens', amount: 22.50, type: 'debit', sourceAccount: 'Cartão de Crédito Nubank' },
  { id: 3, date: '2025-07-06', description: 'Salário Empresa X', amount: 7000.00, type: 'credit', sourceAccount: 'Conta Corrente Itaú' },
  { id: 4, date: '2025-07-06', description: 'Supermercado Pão de Açúcar', amount: 432.80, type: 'debit', sourceAccount: 'Cartão de Débito Itaú' },
  { id: 5, date: '2025-07-05', description: 'Cinema Cinemark', amount: 65.00, type: 'debit', sourceAccount: 'Cartão de Crédito Nubank' },
  { id: 6, date: '2025-07-05', description: 'Pagamento Fatura Net', amount: 119.90, type: 'debit', sourceAccount: 'Conta Corrente Itaú' },
  { id: 7, date: '2025-07-04', description: 'Farmácia Droga Raia', amount: 89.50, type: 'debit', sourceAccount: 'Cartão de Débito Itaú' },
  { id: 8, date: '2025-07-03', description: 'Compra na Amazon.com.br', amount: 159.90, type: 'debit', sourceAccount: 'Cartão de Crédito Nubank' },
];

const categorizeByAI = (description) => {
    const desc = description.toLowerCase();
    if (desc.includes('ifood') || desc.includes('restaurante')) return 'alimentacao';
    if (desc.includes('uber') || desc.includes('99') || desc.includes('posto')) return 'transporte';
    if (desc.includes('supermercado') || desc.includes('mercado')) return 'alimentacao';
    if (desc.includes('cinema') || desc.includes('show') || desc.includes('bar')) return 'lazer';
    if (desc.includes('amazon') || desc.includes('livraria') || desc.includes('loja')) return 'compras';
    if (desc.includes('farmácia') || desc.includes('droga')) return 'saude';
    if (desc.includes('net') || desc.includes('claro') || desc.includes('taxa')) return 'servicos';
    return null; // Retorna null para que o usuário possa categorizar
};

const TelaFluxoDeCaixa = () => {
    const [transacoes, setTransacoes] = useState([]);

    // ##### NOVO: Estado para controlar os filtros #####
    const [filtros, setFiltros] = useState({
        mes: 'todos',
        ano: 'todos',
        categoria: 'todas',
        busca: '',
    });

    useEffect(() => {
        const transacoesCategorizadas = mockTransacoes.map(t => ({
            ...t,
            category: t.type === 'credit' ? 'receita' : categorizeByAI(t.description),
            isIgnored: false
        }));
        setTransacoes(transacoesCategorizadas);
    }, []);

    // ##### NOVO: Lógica para gerar as opções dos filtros dinamicamente #####
    const opcoesFiltro = useMemo(() => {
        const datas = transacoes.map(t => new Date(t.date));
        const anos = [...new Set(datas.map(d => d.getFullYear()))].sort((a,b) => b - a);
        const meses = [
            { v: 1, n: 'Janeiro' }, { v: 2, n: 'Fevereiro' }, { v: 3, n: 'Março' },
            { v: 4, n: 'Abril' }, { v: 5, n: 'Maio' }, { v: 6, n: 'Junho' },
            { v: 7, n: 'Julho' }, { v: 8, n: 'Agosto' }, { v: 9, n: 'Setembro' },
            { v: 10, n: 'Outubro' }, { v: 11, n: 'Novembro' }, { v: 12, n: 'Dezembro' }
        ];
        return { anos, meses };
    }, [transacoes]);

    // ##### NOVO: Lógica principal de filtragem das transações #####
    const transacoesFiltradas = useMemo(() => {
        return transacoes.filter(t => {
            const dataTransacao = new Date(t.date);
            const anoTransacao = dataTransacao.getFullYear();
            const mesTransacao = dataTransacao.getMonth() + 1; // getMonth() é 0-indexed

            const filtroAnoOk = filtros.ano === 'todos' || anoTransacao === parseInt(filtros.ano);
            const filtroMesOk = filtros.mes === 'todos' || mesTransacao === parseInt(filtros.mes);
            
            const filtroCategoriaOk = (() => {
                if (filtros.categoria === 'todas') return true;
                if (filtros.categoria === 'nao-categorizadas') return t.category === null;
                return t.category === filtros.categoria;
            })();

            const filtroBuscaOk = filtros.busca === '' || t.description.toLowerCase().includes(filtros.busca.toLowerCase());

            return filtroAnoOk && filtroMesOk && filtroCategoriaOk && filtroBuscaOk;
        });
    }, [transacoes, filtros]);
    
    // ##### ALTERAÇÃO: Sumário agora usa os dados filtrados #####
    const sumarioPorCategoria = useMemo(() => {
        const gastos = transacoesFiltradas.filter(t => t.type === 'debit' && !t.isIgnored && t.category !== 'receita');
        const totais = gastos.reduce((acc, t) => {
            if (t.category) {
                if (!acc[t.category]) acc[t.category] = 0;
                acc[t.category] += t.amount;
            }
            return acc;
        }, {});
        return Object.entries(totais).map(([key, value]) => ({ id: key, ...CATEGORIAS_FLUXO[key], total: value, })).sort((a, b) => b.total - a.total);
    }, [transacoesFiltradas]);

    const handleCategoryChange = (transactionId, newCategory) => {
        setTransacoes(prev => prev.map(t => t.id === transactionId ? { ...t, category: newCategory || null } : t));
    };

    const handleIgnoreToggle = (transactionId) => {
        setTransacoes(prev => prev.map(t => t.id === transactionId ? { ...t, isIgnored: !t.isIgnored } : t));
    };

    const handleFiltroChange = (e) => {
        const { name, value } = e.target;
        setFiltros(prev => ({...prev, [name]: value}));
    };

    return (
        <div className="max-w-6xl mx-auto space-y-6">
            
            {/* ##### NOVO: Barra de Filtros e Busca ##### */}
            <Card>
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input 
                        type="text"
                        name="busca"
                        placeholder="Pesquisar na descrição..."
                        value={filtros.busca}
                        onChange={handleFiltroChange}
                        className="md:col-span-2 w-full bg-[#2a246f] text-white rounded-md px-3 py-2 border border-[#3e388b] focus:ring-1 focus:ring-[#00d971]"
                    />
                    <select name="categoria" value={filtros.categoria} onChange={handleFiltroChange} className="w-full bg-[#2a246f] text-white text-sm rounded-md p-2 border border-[#3e388b] focus:ring-1 focus:ring-[#00d971]">
                        <option value="todas">Todas as Categorias</option>
                        {Object.entries(CATEGORIAS_FLUXO).map(([key, { label }]) => (<option key={key} value={key}>{label}</option>))}
                        <option value="nao-categorizadas">Não Categorizadas</option>
                    </select>
                    <div className="grid grid-cols-2 gap-2">
                        <select name="mes" value={filtros.mes} onChange={handleFiltroChange} className="w-full bg-[#2a246f] text-white text-sm rounded-md p-2 border border-[#3e388b] focus:ring-1 focus:ring-[#00d971]">
                           <option value="todos">Todos os Meses</option>
                           {opcoesFiltro.meses.map(m => <option key={m.v} value={m.v}>{m.n}</option>)}
                        </select>
                        <select name="ano" value={filtros.ano} onChange={handleFiltroChange} className="w-full bg-[#2a246f] text-white text-sm rounded-md p-2 border border-[#3e388b] focus:ring-1 focus:ring-[#00d971]">
                            <option value="todos">Todos os Anos</option>
                            {opcoesFiltro.anos.map(a => <option key={a} value={a}>{a}</option>)}
                        </select>
                    </div>
                </div>
            </Card>

            <Card>
                <h2 className="text-lg font-bold text-white mb-4">Transações</h2>
                <div className="space-y-2">
                    <div className="hidden md:grid grid-cols-12 gap-4 text-xs font-bold text-slate-800 dark:text-white px-4 py-2">
                        <div className="col-span-1">Data</div><div className="col-span-4">Descrição</div><div className="col-span-3">Categoria</div><div className="col-span-2 text-right">Valor</div><div className="col-span-2 text-center">Ações</div>
                    </div>
                    {/* ##### ALTERAÇÃO: Renderiza a lista filtrada ##### */}
                    {transacoesFiltradas.map(t => {
                        const isCredit = t.type === 'credit';
                        const categoriaInfo = t.category ? CATEGORIAS_FLUXO[t.category] : null;
                        return (
                            <div key={t.id} className={`grid grid-cols-12 gap-4 items-center p-3 rounded-lg transition-colors ${t.isIgnored ? 'bg-gray-800/50 opacity-60' : 'bg-[#2a246f]/50 hover:bg-[#2a246f]'}`}>
                                <div className="col-span-4 md:col-span-1 text-sm text-slate-800 dark:text-white">{new Date(t.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</div>
                                <div className="col-span-8 md:col-span-4 text-white font-medium">{t.description}</div>
                                <div className="col-span-12 md:col-span-3">
                                    {isCredit ? <span className="text-xs font-bold bg-green-500/20 text-green-400 px-2 py-1 rounded-full">Receita</span> : (
                                        <select value={t.category || ''} onChange={(e) => handleCategoryChange(t.id, e.target.value)} className="w-full bg-[#201b5d] text-white text-sm rounded-md p-1 border border-[#3e388b] focus:ring-1 focus:ring-[#00d971]">
                                            <option value="">Selecione...</option>
                                            {Object.entries(CATEGORIAS_FLUXO).map(([key, { label }]) => (<option key={key} value={key}>{label}</option>))}
                                        </select>
                                    )}
                                </div>
                                <div className={`col-span-6 md:col-span-2 text-right font-semibold ${isCredit ? 'text-green-400' : 'text-red-400'}`}>{isCredit ? '+' : '-'} {formatCurrency(t.amount)}</div>
                                <div className="col-span-6 md:col-span-2 flex justify-center"><button onClick={() => handleIgnoreToggle(t.id)} title={t.isIgnored ? "Restaurar Transação" : "Ignorar Transação"} className="text-slate-800 dark:text-white hover:text-white">{t.isIgnored ? <Eye size={18} /> : <EyeOff size={18} />}</button></div>
                            </div>
                        )
                    })}
                </div>
            </Card>

            <Card>
                <h2 className="text-lg font-bold text-white mb-4">Resumo por Categoria (Gastos)</h2>
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    {sumarioPorCategoria.map(cat => {
                        const Icon = cat.icon;
                        return (
                            <div key={cat.id} className="p-4 rounded-lg flex items-center gap-4" style={{ backgroundColor: `${cat.color}20` }}>
                                <div className="p-2 rounded-full" style={{ backgroundColor: `${cat.color}40`}}><Icon size={20} style={{ color: cat.color }}/></div>
                                <div><p className="text-sm text-slate-800 dark:text-white">{cat.label}</p><p className="text-lg font-bold text-white">{formatCurrency(cat.total)}</p></div>
                            </div>
                        )
                    })}
                </div>
            </Card>
        </div>
    );
};


// SUBSTITUA TODO O SEU COMPONENTE "App" POR ESTE CÓDIGO FINAL

export default function App() {
const { theme, toggleTheme } = useContext(ThemeContext);
  const [currentPage, setCurrentPage] = useState('login');
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [categorias, setCategorias] = useState(initialOrcamentoData);
  const [patrimonioData, setPatrimonioData] = useState(initialPatrimonioData);
  const [openMenu, setOpenMenu] = useState(null);
  // Estado para controlar o menu móvel
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

  // Hooks useMemo (lógica interna completa restaurada)
  const { orcamentoCalculos, pieChartData } = useMemo(() => {
        const totais = { atual: { receitas: 0, despesas: 0 }, sugerido: { receitas: 0, despesas: 0 } };
        const totaisCategorias = { fixos: 0, variaveis: 0, investimentos: 0, renda: 0 };
        let pieData = [];
        categorias.forEach(cat => {
            const totalCatAtual = cat.subItens.reduce((acc, item) => acc + item.atual, 0);
            const totalCatSugerido = cat.subItens.reduce((acc, item) => acc + item.sugerido, 0);
            if (cat.tipo === 'receita') {
                totais.atual.receitas += totalCatAtual;
                totais.sugerido.receitas += totalCatSugerido;
                totaisCategorias.renda += totalCatAtual;
            } else {
                totais.atual.despesas += totalCatAtual;
                totais.sugerido.despesas += totalCatSugerido;
                pieData.push({ name: cat.nome, valueAtual: totalCatAtual, valueSugerido: totalCatSugerido });
                if(cat.id === 'essencial') totaisCategorias.fixos += totalCatAtual;
                if(cat.id === 'variavel') totaisCategorias.variaveis += totalCatAtual;
                if(cat.id === 'investimento') totaisCategorias.investimentos += totalCatAtual;
            }
        });
        const finalPieData = pieData.map(d => ({
            ...d,
            percAtual: totais.atual.despesas > 0 ? ((d.valueAtual / totais.atual.despesas) * 100).toFixed(1) : "0.0",
            percSugerido: totais.sugerido.despesas > 0 ? ((d.valueSugerido / totais.sugerido.despesas) * 100).toFixed(1) : "0.0",
        }));
        return { orcamentoCalculos: { ...totais, categorias: totaisCategorias }, pieChartData: finalPieData };
    }, [categorias]);

    const custoDeVidaMensal = useMemo(() => {
        return categorias
            .filter(c => c.id === 'essencial' || c.id === 'variavel')
            .reduce((acc, cat) => acc + cat.subItens.reduce((subAcc, item) => subAcc + item.atual, 0), 0);
    }, [categorias]);

    const patrimonioTotal = useMemo(() => {
        const totalAtivos = Object.keys(patrimonioData)
            .filter(key => key !== 'dividas')
            .reduce((acc, key) => acc + patrimonioData[key].reduce((sum, item) => sum + item.valor, 0), 0);
        const totalDividas = patrimonioData.dividas.reduce((sum, item) => sum + item.valor, 0);
        return totalAtivos - totalDividas;
    }, [patrimonioData]);

  const menuItems = [
    { id: 'orcamento', label: 'Orçamento', icon: BarChart2 },
    { id: 'protecao', label: 'Proteção', icon: Shield },
    { id: 'reserva', label: 'Reserva', icon: PiggyBank },
    { id: 'aposentadoria', label: 'Aposentadoria', icon: Home },
    { id: 'patrimonio', label: 'Patrimônio', icon: Briefcase },
    { id: 'fluxo-caixa', label: 'Fluxo de Caixa', icon: TrendingUp },
    { 
      id: 'aquisicao', 
      label: 'Aquisição de Bens', 
      icon: ShoppingCart,
      subItems: [
        { id: 'aquisicaoImoveis', label: 'Imóveis', icon: Building2 },
        { id: 'aquisicaoAutomoveis', label: 'Automóveis', icon: Car },
      ] 
    },
  ];

  const renderPage = () => {
    if (!isAuthenticated) {
      switch (currentPage) {
        case 'login': return <TelaLogin setCurrentPage={setCurrentPage} setIsAuthenticated={setIsAuthenticated} />;
        case 'cadastro': return <TelaCadastro setCurrentPage={setCurrentPage} />;
        default: return <TelaLogin setCurrentPage={setCurrentPage} setIsAuthenticated={setIsAuthenticated} />;
      }
    }

    switch (currentPage) {
      case 'orcamento': return <TelaOrcamento categorias={categorias} setCategorias={setCategorias} orcamentoCalculos={orcamentoCalculos} pieChartData={pieChartData} />;
      case 'protecao': return <TelaProtecao rendaMensal={orcamentoCalculos.atual.receitas} custoDeVidaMensal={custoDeVidaMensal} patrimonioTotal={patrimonioTotal}/>;
      case 'reserva': return <TelaReservaEmergencia orcamentoCalculos={orcamentoCalculos} />;
      case 'aposentadoria': return <TelaAposentadoria />;
      case 'patrimonio': return <TelaPatrimonio patrimonioData={patrimonioData} setPatrimonioData={setPatrimonioData} patrimonioTotal={patrimonioTotal} />;
      case 'fluxo-caixa': return <TelaFluxoDeCaixa />;
      case 'aquisicaoImoveis': return <TelaAquisicaoImoveis />;
      case 'aquisicaoAutomoveis': return <TelaAquisicaoAutomoveis />;
      default: return <TelaOrcamento categorias={categorias} setCategorias={setCategorias} orcamentoCalculos={orcamentoCalculos} pieChartData={pieChartData} />;
    }
  };

  if (!isAuthenticated) { return renderPage(); }
 const ThemeToggleButton = () => (
    <button onClick={toggleTheme} className="p-2 rounded-full text-slate-800 dark:text-white hover:bg-[#3e388b]/50">
      {theme === 'dark' ? <Sun size={20} /> : <Moon size={20} className="text-slate-700" />}
    </button>
  );
return (
    <div className="bg-slate-100 dark:bg-gray-900 text-slate-900 dark:text-white min-h-screen font-sans">
      <nav className="bg-white dark:bg-[#201b5d] shadow-lg">
        <div className="max-w-7xl mx-auto px-4">
          <div className="flex items-center justify-between h-16">
             <div className="flex-shrink-0 flex items-center gap-2">
                <img src={logo} alt="Logo SeuConsultor" className="h-14 w-auto" style={{ filter: 'invert(42%) sepia(93%) saturate(2000%) hue-rotate(133deg) brightness(100%) contrast(107%)' }} />
                <span className="font-montserrat text-slate-900 dark:text-white text-xl font-extrabold">SeuConsultor</span>
             </div>
             
             <div className="hidden md:flex items-center space-x-1">
                {menuItems.map(item => (
                    <div key={item.id} className="relative">
                        <button
                            onClick={(e) => { e.preventDefault(); if (item.subItems) { setOpenMenu(openMenu === item.id ? null : item.id); } else { setCurrentPage(item.id); setOpenMenu(null); } }}
                            className={`flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200 ${currentPage.startsWith(item.id) ? 'bg-slate-200 dark:bg-[#00d971] text-slate-900 dark:text-black' : 'text-gray-600 dark:text-slate-800 dark:text-white hover:bg-slate-200/50 dark:hover:bg-[#3e388b]/50'}`}
                        >
                            <item.icon size={16} /><span>{item.label}</span>
                            {item.subItems && <ChevronDown size={14} className={`transition-transform ${openMenu === item.id ? 'rotate-180' : ''}`} />}
                        </button>
                        {item.subItems && openMenu === item.id && (
                             <div className="absolute top-full right-0 mt-2 w-48 bg-white dark:bg-[#201b5d] border border-slate-200 dark:border-[#3e388b] rounded-md shadow-lg z-10">
                                {item.subItems.map(subItem => (
                                    <a key={subItem.id} href="#" onClick={(e) => { e.preventDefault(); setCurrentPage(subItem.id); setOpenMenu(null); }} className="flex items-center gap-2 px-4 py-2 text-sm text-gray-600 dark:text-white hover:bg-slate-100 dark:hover:bg-[#3e388b] w-full">
                                        <subItem.icon size={16} />{subItem.label}
                                    </a>
                                ))}
                            </div>
                        )}
                    </div>
                ))}
                <ThemeToggleButton />
             </div>

             <div className="md:hidden flex items-center gap-2">
                <ThemeToggleButton />
                <button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)} className="inline-flex items-center justify-center p-2 rounded-md text-slate-800 dark:text-white dark:text-slate-800 dark:text-white hover:text-white hover:bg-slate-100 dark:hover:bg-[#3e388b]/50 focus:outline-none">
                    <span className="sr-only">Abrir menu</span>
                    {isMobileMenuOpen ? <X size={24} className="text-slate-800 dark:text-white" /> : <Menu size={24} className="text-slate-800 dark:text-white" />}
                </button>
             </div>
          </div>
        </div>
      </nav>

      {isMobileMenuOpen && (
        <div className="md:hidden bg-white dark:bg-[#201b5d] shadow-lg">
            <div className="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                {menuItems.map(item => ( !item.subItems ? ( <a key={item.id} href="#" onClick={(e) => { e.preventDefault(); setCurrentPage(item.id); setIsMobileMenuOpen(false); }} className={`flex items-center gap-3 px-3 py-2 rounded-md text-base font-medium ${currentPage === item.id ? 'bg-slate-200 dark:bg-[#00d971] text-slate-900 dark:text-black' : 'text-gray-600 dark:text-white hover:bg-slate-100 dark:hover:bg-[#3e388b]/50'}`}> <item.icon size={20}/>{item.label}</a> ) : ( <div key={item.id} className="text-gray-600 dark:text-white"> <div className="px-3 pt-2 pb-1 text-sm font-bold text-slate-800 dark:text-white dark:text-slate-800 dark:text-white">{item.label}</div> {item.subItems.map(subItem => ( <a key={subItem.id} href="#" onClick={(e) => { e.preventDefault(); setCurrentPage(subItem.id); setIsMobileMenuOpen(false); }} className={`flex items-center gap-3 pl-8 pr-3 py-2 rounded-md text-base font-medium ${currentPage === subItem.id ? 'bg-slate-200 dark:bg-[#00d971] text-slate-900 dark:text-black' : 'text-gray-600 dark:text-white hover:bg-slate-100 dark:hover:bg-[#3e388b]/50'}`}> <subItem.icon size={20}/>{subItem.label}</a>))}</div>)))}
            </div>
        </div>
      )}
      
      <main className="p-4 md:p-6">{renderPage()}</main>
    </div>
  );
}
